---
title: Установка Advanced Threat Analytics. Шаг 6 | Документация Майкрософт
description: На этом этапе установки ATA настраиваются источники данных.
keywords: ''
author: rkarlin
ms.author: rkarlin
manager: mbaldwin
ms.date: 3/21/2018
ms.topic: conceptual
ms.prod: advanced-threat-analytics
ms.service: ''
ms.technology: ''
ms.assetid: 8980e724-06a6-40b0-8477-27d4cc29fd2b
ms.reviewer: bennyl
ms.suite: ems
ms.openlocfilehash: 366660a600292490c2f7df13b9d276b6accc4b93
ms.sourcegitcommit: 2916d6f8d6e6f754d7fb8a5d31b255a46aa35ecd
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/26/2018
ms.locfileid: "50132628"
---
*Применяется к: Advanced Threat Analytics версии 1.9*



# <a name="install-ata---step-6"></a>Установка ATA. Шаг 6

> [!div class="step-by-step"]
> [« Шаг 5](install-ata-step5.md)
> [Шаг 7 »](vpn-integration-install-step.md)

## <a name="step-6-configure-event-collection"></a>Шаг 6. Настройка сбора данных о событиях
### <a name="configure-event-collection"></a>Настройка сбора данных о событиях
Чтобы улучшить возможности обнаружения, ATA требуется доступ к следующим событиям Windows: 4776, 4732, 4733, 4728, 4729, 4756, 4757 и 7045. Они могут считываться автоматически упрощенным шлюзом ATA либо, если упрощенный шлюз ATA не развернут, передаваться в шлюз ATA одним из двух способов: путем настройки прослушивания событий SIEM в шлюзе ATA или [пересылки событий Windows](configure-event-collection.md). 

> [!NOTE]
> В версии ATA 1.8 и более поздних настройка сбора событий для упрощенных шлюзов ATA больше не требуется. Упрощенный шлюз ATA теперь может считывать события локально — настраивать переадресацию событий не требуется.

Помимо сбора и анализа входящего и исходящего сетевого трафика с контроллеров домена, ATA может использовать события Windows для улучшенного обнаружения. Событие 4776 улучшает обнаружение различных атак при использовании NTLM, а события 4732, 4733, 4728, 4729, 4756 и 4757 улучшают обнаружение изменения привилегированных групп. Оно может быть получено от вашего SIEM или в случае настройки переадресации событий Windows на вашем контроллере домена. Собранные события предоставляют ATA дополнительные данные, которые невозможно получить через сетевой трафик контроллера домена.

#### <a name="siemsyslog"></a>Система SIEM/системный журнал
Для обработки ATA данных с сервера системного журнала необходимо выполнить следующие шаги:

-   Выполните настройку серверов шлюза ATA на прослушивание и прием событий, перенаправляемых с сервера SIEM или системного журнала.

> [!NOTE]
> ATA прослушивает только IPv4, но не IPv6. 
-   Выполните настройку сервера SIEM или системного журнала на пересылку определенных событий на шлюз ATA.

> [!IMPORTANT]
> -   Не выполняйте пересылку всех данных системного журнала на шлюз ATA.
> -   ATA поддерживает трафик UDP с сервера SIEM или системного журнала.

Подробности о настройке пересылки событий на другой сервер см. в документации по серверу SIEM или системному журналу. 

> [!NOTE]
>Если сервер SIEM или системный журнал отсутствуют, настройку контроллеров домена Windows можно выполнить таким образом, чтобы АТА выполнял сбор и анализ событий 4776 с журнала событий Windows. События 4776 с журнала событий Windows содержат информацию о проверках подлинности NTLM.

#### <a name="configuring-the-ata-gateway-to-listen-for-siem-events"></a>Настройка прослушивания событий SIEM в шлюзе ATA

1.  В разделе настройки ATA на вкладке **Источники данных** щелкните **SIEM**, включите **Системный журнал** и нажмите кнопку **Сохранить**.

    ![Разрешите использование образа UDP для прослушивания системного журнала](media/ATA-enable-siem-forward-events.png)

2.  Выполните настройку сервера SIEM или системного журнала таким образом, чтобы события с идентификатором 4776 от журнала событий Windows направлялись на один из шлюзов ATA. Дополнительные сведения о настройке SIEM см. в справке в Интернете. Сведения об особых требованиях к форматированию каждого сервера SIEM см. в вариантах технической поддержки.

ATA поддерживает события SIEM в следующих форматах:  

#### <a name="rsa-security-analytics"></a>Аналитика безопасности RSA
&lt;Заголовок системного журнала&gt;RsaSA\n2015-May-19 09:07:09\n4776\nMicrosoft-Windows-Security-Auditing\nSecurity\XXXXX.subDomain.domain.org.il\nYYYYY$\nMMMMM \n0x0

-   Заголовок системного журнала необязателен.

-   Между всеми полями должен стоять символ-разделитель "\n".

-   Поля в порядке очередности:

    1.  Постоянное значение RsaSA (должно появиться).

    2.  Метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение желательно представлять в миллисекундах.

    3.  код события Windows.

    4.  Имя поставщика событий Windows

    5.  Имя журнала событий Windows

    6.  Имя компьютера, получающего событие (в данном случае контроллера домена)

    7.  Имя пользователя, подлинность которого проверяется

    8.  Имя исходного узла

    9. Код результата NTLM

-   Поскольку порядок важен, в сообщении не должно быть ничего другого.

#### <a name="hp-arcsight"></a>HP Arcsight
CEF:0|Microsoft|Microsoft Windows||Microsoft-Windows-Security-Auditing:4776|Контроллер домена попытался проверить учетные данные для учетной записи.|Low| externalId=4776 cat=Security rt=1426218619000 shost=KKKKKK dhost=YYYYYY.subDomain.domain.com duser=XXXXXX cs2=Security cs3=Microsoft-Windows-Security-Auditing cs4=0x0 cs3Label=EventSource cs4Label=Reason or Error Code

-   Должно соответствовать определению протокола.

-   Отсутствует заголовок системного журнала.

-   Заголовок определения (часть, разделенная вертикальной линией) должен существовать (как указано в протоколе).

-   В _расширении_ должны присутствовать следующие ключи:

    -   externalId = код события Windows

    -   rt = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение желательно представлять в миллисекундах.

    -   cat = имя журнала событий Windows

    -   shost = имя исходного узла

    -   dhost = имя компьютера, получающего событие (в данном случае контроллера домена)

    -   duser = имя пользователя, подлинность которого проверяется

-   Для _расширения_ порядок представления неважен

-   Для следующих двух полей следует назначить отдельный ключ и метку ключа:

    -   "EventSource"

    -   "Reason or Error Code" = код результата NTLM

#### <a name="splunk"></a>Splunk
&lt;Заголовок системного журнала&gt;\r\nEventCode=4776\r\nLogfile=Security\r\nSourceName=Microsoft-Windows-Security-Auditing\r\nTimeGenerated=20150310132717.784882-000\r\ComputerName=YYYYY\r\nMessage=

Компьютер попытался проверить учетные данные для учетной записи.

Пакет проверки подлинности:              MICROSOFT_AUTHENTICATION_PACKAGE_V1_0

Учетная запись входа: администратор

Исходная рабочая станция:       SIEM

Код ошибки:         0x0

-   Заголовок системного журнала необязателен.

-   Между всеми обязательными полями стоит символ-разделитель "\r\n".

-   Поля имеют формат ключ = значение.

-   Наличие следующих ключей и их значений обязательно:

    -   EventCode = код события Windows

    -   Logfile = имя журнала событий Windows

    -   SourceName = имя поставщика событий Windows

    -   TimeGenerated = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

    -   ComputerName = имя исходного узла

    -   Message = исходный текст события Windows

-   Ключ сообщения и его значение должны быть в конце.

-   Для пар ключ=значение порядок представления неважен.

#### <a name="qradar"></a>QRadar
QRadar активирует сбор данных о событиях через агента. Если сбор данных происходит с помощью агента, то формат времени представляется без указания миллисекунд. Так как ATA требуются данные о миллисекундах, необходимо настроить в QRadar сбор данных о событиях Windows без агента. Дополнительные сведения см. в статье[http://www-01.ibm.com/support/docview.wss?uid=swg21700170](http://www-01.ibm.com/support/docview.wss?uid=swg21700170 "QRadar: Agentless Windows Events Collection using the MSRPC Protocol") (QRadar: безагентный сбор данных о событиях Windows с помощью протокола MSRPC).

    <13>Feb 11 00:00:00 %IPADDRESS% AgentDevice=WindowsLog AgentLogFile=Security Source=Microsoft-Windows-Security-Auditing Computer=%FQDN% User= Domain= EventID=4776 EventIDCode=4776 EventType=8 EventCategory=14336 RecordNumber=1961417 TimeGenerated=1456144380009 TimeWritten=1456144380009 Message=The computer attempted to validate the credentials for an account. Authentication Package: MICROSOFT_AUTHENTICATION_PACKAGE_V1_0 Logon Account: Administrator Source Workstation: HOSTNAME Error Code: 0x0

Необходимо задать следующие сведения в полях:

- тип агента для сбора данных;
- имя поставщика журнала событий Windows;
- источник журнала событий Windows;
- полное доменное имя контроллера домена;
- код события Windows.

TimeGenerated — это метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

Message — это исходный текст события Windows.

Между парами "ключ-значение" должен быть разделитель \t.

>[!NOTE] 
> Использование WinCollect для сбора данных о событиях Windows не поддерживается.



> [!div class="step-by-step"]
> [« Шаг 5](install-ata-step5.md)
> [Шаг 7 »](vpn-integration-install-step.md)



## <a name="related-videos"></a>Видео по теме
- [Обзор развертывания ATA](https://channel9.msdn.com/Shows/Microsoft-Security/Overview-of-ATA-Deployment-in-10-Minutes)
- [Выбор правильного типа шлюза ATA](https://channel9.msdn.com/Shows/Microsoft-Security/ATA-Deployment-Choose-the-Right-Gateway-Type)


## <a name="see-also"></a>См. также
- [Руководство по развертыванию среды для подтверждения концепции ATA](http://aka.ms/atapoc)
- [Средство изменения размера ATA](http://aka.ms/atasizingtool)
- [Ознакомьтесь с форумом ATA.](https://social.technet.microsoft.com/Forums/security/home?forum=mata)
- [Настройка сбора данных о событиях](configure-event-collection.md)
- [Предварительные требования ATA](ata-prerequisites.md)

