---
title: Архитектура Advanced Threat Analytics | Документация Майкрософт
description: Здесь описывается архитектура решения Microsoft Advance Threat Analytics
keywords: ''
author: shsagir
ms.author: shsagir
manager: rkarlin
ms.date: 09/08/2019
ms.topic: conceptual
ms.prod: advanced-threat-analytics
ms.technology: ''
ms.assetid: 892b16d2-58a6-49f9-8693-1e5f69d8299c
ms.reviewer: bennyl
ms.suite: ems
ms.openlocfilehash: 179cf31a6f9c8c62670ea96d671f209712325f56
ms.sourcegitcommit: 9673eb49729a06d3a25d52c0f43c76ac61b9cf89
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2020
ms.locfileid: "75905192"
---
# <a name="ata-architecture"></a>Архитектура ATA

*Применяется к: Advanced Threat Analytics версии 1.9*

Архитектура решения Microsoft Advanced Threat Analytics (ATA) подробно представлена на следующей схеме:

![Схема топологии архитектуры ATA](media/ATA-architecture-topology.jpg)

ATA отслеживает сетевой трафик контроллеров домена, используя зеркальное отображение портов на шлюз ATA с помощью физических или виртуальных коммутаторов. При развертывании упрощенного шлюза ATA непосредственно на контроллерах домена зеркальное отображение портов не требуется. Кроме того, ATA может использовать события Windows (которые пересылаются непосредственно из контроллеров домена или сервера SIEM) и анализировать данные, связанные с атаками и угрозами.
В этом разделе рассматривается поток фиксации сетевого трафика и событий, а также подробно описаны функции основных компонентов ATA: шлюза ATA, упрощенного шлюза ATA (основные функции этих двух компонентов совпадают) и центра ATA.


![Блок-схема потока трафика ATA](media/ATA-traffic-flow.jpg)

## <a name="ata-components"></a>Компоненты ATA
Решение ATA включает в себя следующие компоненты.

-   **Центр ATA** <br>
Центр ATA получает данные от всех развернутых шлюзов ATA и упрощенных шлюзов ATA.
-   **Шлюз ATA**<br>
Шлюз ATA устанавливается на выделенном сервере, отслеживающем трафик от контроллеров домена, посредством зеркального отображения портов или перехватчика трафика.
-   **Упрощенный шлюз ATA**<br>
Упрощенный шлюз ATA устанавливается непосредственно на контроллерах домена и напрямую отслеживает их трафик. Для этого не нужен выделенный сервер и не требуется настраивать зеркальное отображение портов. Он представляет собой альтернативу шлюзу ATA.

Развертывание ATA может состоять из одного центра ATA, подключенного ко всем шлюзам ATA, всем упрощенным шлюзам ATA или и к тем и к другим одновременно.


## <a name="deployment-options"></a>Варианты развертывания
При развертывании ATA можно использовать следующие сочетания шлюзов:

-   **Только шлюзы ATA** <br>
В развертывании ATA могут быть только шлюзы ATA, но не упрощенные шлюзы ATA: для всех контроллеров домена необходимо включить зеркальное отображение портов на шлюз ATA либо нужно настроить перехватчики трафика.
-   **Только упрощенные шлюзы ATA**<br>
В развертывании ATA могут быть только упрощенные шлюзы ATA: они развертываются на каждом контроллере домена. При этом не нужно настраивать дополнительные серверы или зеркальное отображение портов.
-   **Шлюзы ATA и упрощенные шлюзы ATA**<br>
Развертывание ATA содержит как обычные, так и упрощенные шлюзы ATA. Упрощенные шлюзы ATA устанавливаются на некоторых контроллерах домена (например, на всех контроллерах домена на сайтах филиалов). В то же время трафик других контроллеров домена (например, контроллеров домена большого размера в основных центрах обработки данных) отслеживают шлюзы ATA.

Во всех этих сценариях все шлюзы отправляют данные центру ATA.


## <a name="ata-center"></a>Центр АТА
**Центр ATA** выполняет следующие функции:

-   управление параметрами конфигурации шлюза ATA и упрощенного шлюза ATA;

-   получение данных от шлюзов ATA и упрощенных шлюзов ATA; 

-   выявление подозрительных действий;

-   выполнение алгоритмов машинного обучения ATA для анализа поведения, чтобы обнаружить необычное поведение;

-   выполнение различных детерминированных алгоритмов для выявления продвинутых атак в цепочке атаки;

-   обеспечение работы консоли ATA;

-   отправка уведомлений о подозрительных действиях по электронной почте (настраивается отдельно).

Центр ATA получает проанализированный трафик из шлюза ATA и упрощенного шлюза ATA. После этого выполняется профилирование, детерминированное обнаружение и запуск алгоритмов машинного обучения и анализа поведения. Это позволяет получить сведения о сети, выявить аномалии и сообщить о подозрительных действиях.

|||
|-|-|
|Получатель сущностей|Этот компонент получает пакеты сущностей из всех шлюзов ATA и упрощенных шлюзов ATA.|
|Обработчик сетевых операций|Этот компонент обрабатывает все сетевые операции в каждом полученном пакете. К примеру, он сопоставляет различные действия Kerberos, выполненные на разных компьютерах.|
|Профилировщик сущностей|Этот компонент профилирует все уникальные сущности в соответствии с трафиком и событиями. Например, ATA обновляет список компьютеров, с которых выполнен вход, для каждого профиля пользователя.|
|База данных центра|Этот компонент управляет процессом записи сетевых операций и событий в базу данных. |
|База данных|ATA использует базу данных MongoDB для хранения в системе следующих данных:<br /><br />— сетевых операций;<br />— действий-событий;<br />— уникальных сущностей;<br />— подозрительных действий;<br />— данных конфигурации ATA.|
|Средства обнаружения|Эти компоненты выявляют подозрительные действия и аномальное поведение пользователей в сети, используя алгоритмы машинного обучения и детерминированные правила.|
|Консоль ATA|Этот компонент используется для настройки решения ATA и отслеживания подозрительных сетевых действий, обнаруженных этим решением. Консоль ATA не зависит от службы центра ATA и работает даже после ее остановки, если связь с базой данных не потеряна.|

При определении числа центров ATA, которые необходимо развернуть в сети, учитывайте указанные ниже критерии.

-   Один центр ATA может отслеживать лишь один лес Active Directory. При наличии нескольких лесов Active Directory для каждого из них требуется по крайней мере один центр ATA.

-    При крупных развертываниях Active Directory одного центра ATA может быть недостаточно для обработки всего трафика из контроллеров домена. В этом случае требуется несколько центров ATA. Число центров ATA зависит от [планирования производительности решения](ata-capacity-planning.md).

## <a name="ata-gateway-and-ata-lightweight-gateway"></a>Шлюз ATA и упрощенный шлюз ATA

### <a name="gateway-core-functionality"></a>Основные функции шлюза
**Шлюз ATA** и **упрощенный шлюз ATA** выполняют одинаковые основные функции:

-   фиксация и проверка сетевого трафика контроллеров домена (трафик на зеркально отображенных портах для шлюзов ATA и локальный трафик контроллера домена для упрощенных шлюзов ATA); 

-   получение событий Windows с серверов SIEM или серверов системного журнала либо из контроллеров домена с помощью функции пересылки событий Windows;

-   получение данных о пользователях и компьютерах из домена Active Directory;

-   разрешение сетевых сущностей (пользователей, групп и компьютеров);

-   передача соответствующих данных в центр ATA;

-   мониторинг нескольких контроллеров домена из одного шлюза ATA или одного контроллера домена для упрощенного шлюза ATA.

Шлюз ATA получает сетевой трафик и события Windows из сети и обрабатывает их с помощью следующих основных компонентов:

|||
|-|-|
|Прослушиватель сети|Этот компонент фиксирует и анализирует сетевой трафик. Эта задача существенно нагружает ЦП, поэтому при настройке шлюза ATA и упрощенного шлюза ATA необходимо выполнить [предварительные требования для ATA](ata-prerequisites.md).|
|Прослушиватель событий|Этот компонент фиксирует и анализирует события Windows, пересылаемые с сервера SIEM в сети.|
|Средство чтения журнала событий Windows|Этот компонент считывает и анализирует события Windows, пересылаемые в журнал событий Windows шлюза ATA с контроллеров домена.|
|Транслятор сетевых операций | Этот компонент преобразует проанализированный трафик (сетевые операции) в логическое представление трафика ATA.
|Сопоставитель сущностей|Этот компонент принимает проанализированные данные (сетевой трафик и события) и разрешает их с помощью Active Directory, чтобы найти сведения об учетных записях и удостоверениях. Затем они сопоставляются с IP-адресами в этих данных. Сопоставитель сущностей проверяет заголовки пакетов и анализирует пакеты аутентификации для определения имен, свойств и удостоверений компьютеров. Затем он объединяет проанализированные пакеты аутентификации с данными в пакете.|
|Отправитель сущностей|Этот компонент отправляет проанализированные и сопоставленные данные в центр ATA.|

## <a name="ata-lightweight-gateway-features"></a>Функции упрощенного шлюза ATA

Следующие компоненты и возможности работают по-разному в шлюзе ATA и упрощенном шлюзе ATA.

-   Упрощенный шлюз ATA может считывать события локально — настраивать переадресацию событий не требуется.

-   **Потенциальный синхронизатор домена**<br>
Шлюз синхронизатора домена отвечает за своевременную синхронизацию всех сущностей из определенного домена Active Directory (аналогичный механизм используется для репликации в контроллерах домена). В списке синхронизаторов домена случайным образом выбирается один шлюз. <br><br>
Если синхронизатор находится в автономном режиме более 30 минут, его заменяет другой кандидат. Если для определенного домена не существует кандидата на синхронизатор домена, ATA выполняет предварительную синхронизацию сущностей и их изменений, однако ATA будет активно получать новые сущности по мере их обнаружения в отслеживаемом трафике. 
<br>Если синхронизатор домена недоступен, при поиске сущности без трафика, связанной с ней, не отображаются результаты.<br><br>
По умолчанию все шлюзы ATA являются кандидатами для синхронизатора домена.<br><br>
Так как все упрощенные шлюзы ATA, скорее всего, развертываются на сайтах филиалов и на небольших контроллерах домена, они по умолчанию не рассматриваются в качестве потенциальных синхронизаторов. <br><br>В среде с простыми шлюзами рекомендуется назначить два шлюза в качестве кандидатов для синхронизатора, где один упрощенный шлюз является кандидатом синхронизатора по умолчанию, а второй — с резервной копией в случае, если значение по умолчанию — "вне сети" более 30. тезис. 


-   **Ограничения ресурсов**<br>
Упрощенный шлюз ATA содержит компонент мониторинга, который оценивает доступный объем вычислительных ресурсов и памяти на контроллере домена, в котором он выполняется. Мониторинг выполняется каждые 10 секунд. При этом также осуществляется динамическое обновление квоты использования ресурсов ЦП и памяти для упрощенного шлюза ATA. Благодаря этому в любой момент времени на контроллере домена доступно по крайней мере 15 % свободных вычислительных ресурсов и ресурсов памяти.<br><br>
Независимо от операций, выполняемых на контроллере домена, в результате всегда освобождаются ресурсы, чтобы обеспечить непрерывную работу основных функций контроллера домена.<br><br>
Если это приводит к нехватке ресурсов упрощенного шлюза ATA, отслеживается только часть трафика, а на странице работоспособности появится оповещение мониторинга Dropped port mirrored network traffic (Сетевой трафик зеркально отображенных портов сброшен).

В таблице ниже приведен пример контроллера домена с достаточным количеством вычислительных ресурсов для больших квот, чем нужны в данный момент, чтобы обеспечить мониторинг всего трафика:

||||||
|-|-|-|-|-|
|Active Directory (Lsass.exe)|Упрощенный шлюз ATA (Microsoft.Tri.Gateway.exe)|Разное (другие процессы) |Квота упрощенного шлюза ATA|Сброс шлюза|
|30 %|20 %|10 %|45 %|Нет|

Если Active Directory требуются дополнительные вычислительные ресурсы, квота для упрощенного шлюза ATA сокращается. В следующем примере упрощенному шлюзу ATA требуется больше ресурсов, чем выделено квотой. Поэтому он сбрасывает некоторый трафик (выполняется мониторинг только части трафика):

||||||
|-|-|-|-|-|
|Active Directory (Lsass.exe)|Упрощенный шлюз ATA (Microsoft.Tri.Gateway.exe)|Разное (другие процессы) |Квота упрощенного шлюза ATA|Выполняется ли сброс шлюза|
|60 %|15 %|10 %|15 %|да|


## <a name="your-network-components"></a>Компоненты сети
Для работы с ATA убедитесь, что настроены следующие компоненты.

### <a name="port-mirroring"></a>Зеркальное отображение портов
При использовании шлюзов ATA необходимо настроить зеркальное отображение портов для контроллеров домена, которые будут отслеживаться, и указать шлюз ATA в качестве места назначения с помощью физических или виртуальных коммутаторов. Кроме того, можно использовать перехватчик трафика. ATA будет работать, если мониторинг выполняется только для некоторых контроллеров домена, однако эффективность обнаружения будет ниже.

Хотя при зеркальном отображении портов шлюз ATA получает весь зеркально отображенный сетевой трафик контроллера домена, для анализа в центр ATA отправляется лишь небольшой объем данных о трафике в сжатом виде.

Контроллеры домена и шлюзы ATA могут быть как физическими, так и виртуальными. Дополнительные сведения см. в разделе [Настройка зеркального отображения портов](configure-port-mirroring.md).


### <a name="events"></a>Элемент Event
Для повышения эффективности обнаружения атак Pass-the-Hash, атак методом подбора, атак путем изменения привилегированных групп и атак с использованием honeytoken решению ATA требуется доступ к следующим событиям Windows: 4776, 4732, 4733, 4728, 4729, 4756, 4757. Они могут считываться автоматически упрощенным шлюзом ATA либо, если упрощенный шлюз ATA не развернут, передаваться в шлюз ATA одним из двух способов: путем настройки прослушивания событий SIEM в шлюзе ATA или [пересылки событий Windows](configure-event-collection.md).

-   Настройка прослушивания событий SIEM в шлюзе ATA <br>Настройте пересылку определенных событий Windows из системы SIEM в ATA. ATA поддерживает несколько поставщиков SIEM. Дополнительные сведения см. в статье [Настройка сбора данных о событиях](configure-event-collection.md).

-   Настройка пересылки событий Windows<br>Чтобы обеспечить отправку сведений о событиях в ATA, можно также настроить пересылку событий Windows 4776, 4732, 4733, 4728, 4729, 4756 и 4757 с контроллеров домена в шлюз ATA. Это целесообразно, если у вас нет SIEM или ваша версия SIEM в настоящее время не поддерживается в ATA. Чтобы завершить настройку пересылки событий Windows в ATA см. раздел [Настройка пересылки событий Windows](configure-event-collection.md). Это относится только к физическим шлюзам ATA, но не к упрощенному шлюзу ATA.

## <a name="related-videos"></a>Видео по теме
- [Выбор правильного типа шлюза ATA](https://channel9.msdn.com/Shows/Microsoft-Security/ATA-Deployment-Choose-the-Right-Gateway-Type)


## <a name="see-also"></a>См. также
- [Предварительные требования ATA](ata-prerequisites.md)
- [Средство изменения размера ATA](https://aka.ms/atasizingtool)
- [Планирование производительности ATA](ata-capacity-planning.md)
- [Настройка сбора данных о событиях](configure-event-collection.md)
- [Настройка пересылки событий Windows](configure-event-collection.md)
- [Ознакомьтесь с форумом ATA.](https://social.technet.microsoft.com/Forums/security/home?forum=mata)

