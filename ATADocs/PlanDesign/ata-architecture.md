---
title: "Архитектура ATA | Microsoft Advanced Threat Analytics"
description: "Здесь описывается архитектура решения Microsoft Advance Threat Analytics"
keywords: 
author: rkarlin
manager: stevenpo
ms.date: 04/28/2016
ms.topic: article
ms.prod: identity-ata
ms.service: advanced-threat-analytics
ms.technology: security
ms.assetid: 892b16d2-58a6-49f9-8693-1e5f69d8299c
ms.reviewer: bennyl
ms.suite: ems
translationtype: Human Translation
ms.sourcegitcommit: 8d1dedaf86031e8585cca23241aead58f7f3db4e
ms.openlocfilehash: 2d753060f30cbcc7d16959355b86d64fdaa2ecd8


---

# Архитектура ATA
Архитектура решения Microsoft Advanced Threat Analytics (ATA) подробно представлена на следующей схеме:

![Схема топологии архитектуры ATA](media/ATA-architecture-topology.jpg)

ATA отслеживает сетевой трафик контроллера домена к шлюзу ATA за счет зеркального отображения портов, используя физические или виртуальные коммутаторы, или развертывания упрощенного шлюза ATA непосредственно на контроллерах домена. Это, в свою очередь, устраняет необходимость зеркального отображения портов. Кроме того, ATA может использовать события Windows (которые пересылаются непосредственно из контроллеров домена или сервера SIEM) и анализировать данные, связанные с атаками и угрозами.
В этом разделе рассматривается процесс фиксации сетевого трафика и событий, а также подробно описаны функции основных компонентов ATA: шлюза ATA, упрощенного шлюза ATA (основные функции этих двух компонентов совпадают) и центра ATA.


![Схема процесса фиксации трафика ATA](media/ATA-traffic-flow.jpg)

## Компоненты ATA
Решение ATA включает в себя следующие компоненты:

-   **Центр АТА** <br>
Центр ATA получает данные от всех развернутых шлюзов ATA и упрощенных шлюзов ATA.
-   **Шлюз ATA**<br>
Шлюз ATA устанавливается на выделенном сервере, отслеживающем трафик от контроллеров домена, посредством зеркального отображения портов или перехватчика трафика.
-   **Упрощенный шлюз ATA**<br>
Упрощенный шлюз ATA устанавливается непосредственно на контроллерах домена и напрямую отслеживает их трафик. Для этого не нужен выделенный сервер и не требуется настраивать зеркальное отображение портов. Он представляет собой альтернативу шлюзу ATA.

Развертывание ATA может состоять из одного центра ATA, подключенного ко всем шлюзам ATA, всем упрощенным шлюзам ATA или и к тем и к другим одновременно.


## Варианты развертывания
При развертывании ATA можно использовать следующие сочетания шлюзов:

-   **Только шлюзы ATA.** <br>
Если в развертывании ATA есть только шлюзы ATA и нет упрощенных шлюзов ATA, для всех контроллеров домена необходимо включить зеркальное отображение портов к шлюзу ATA либо нужно настроить перехватчики трафика.
-   **Только упрощенные шлюзы ATA.**<br>
Если в развертывании ATA содержатся только упрощенные шлюзы ATA, они развертываются на каждом контроллере домена. При этом не нужно настраивать дополнительные серверы или зеркальное отображение портов.
-   **Шлюзы ATA и упрощенные шлюзы ATA.**<br>
Если развертывание ATA включает шлюзы ATA и упрощенные шлюзы ATA, последние устанавливаются на некоторых контроллерах домена (например, на всех контроллерах домена на сайтах филиалов), а трафик других контроллеров домена (например, контроллеров домена большого размера в основных центрах обработки данных) отслеживают шлюзы ATA.

Во всех трех сценариях все шлюзы отправляют данные центру ATA.




## Центр АТА
**Центр ATA** выполняет следующие функции:

-   управление параметрами конфигурации шлюза ATA и упрощенного шлюза ATA;

-   получение данных от шлюзов ATA и упрощенных шлюзов ATA; 

-   выявление подозрительных действий;

-   выполнение алгоритмов машинного обучения ATA для анализа поведения, чтобы обнаружить необычное поведение;

-   выполнение различных детерминированных алгоритмов для выявления продвинутых атак в цепочке атаки;

-   обеспечение работы консоли ATA;

-   отправка уведомлений о подозрительных действиях по электронной почте (настраивается отдельно).

Центр ATA получает проанализированный трафик из шлюза ATA и упрощенного шлюза ATA, после чего выполняется профилирование, детерминированное обнаружение и запуск алгоритмов машинного обучения и анализа поведения. Это позволяет выявить аномалии и сообщить о подозрительных действиях.

|||
|-|-|
|Получатель сущностей|Этот компонент получает пакеты сущностей из всех шлюзов ATA и упрощенных шлюзов ATA.|
|Обработчик сетевых операций|Этот компонент обрабатывает все сетевые операции в каждом полученном пакете. К примеру, он сопоставляет различные действия Kerberos, выполненные на разных компьютерах.|
|Профилировщик сущностей|Этот компонент профилирует все уникальные сущности в соответствии с трафиком и событиями. Именно с помощью этого компонента ATA обновляет список компьютеров, с которых выполнен вход, для каждого профиля пользователя.|
|База данных центра|Этот компонент управляет процессом записи сетевых операций и событий в базу данных. |
|База данных|ATA использует базу данных MongoDB для хранения в системе следующих данных:<br /><br />— сетевых операций;<br />— действий-событий;<br />— уникальных сущностей;<br />— подозрительных действий;<br />— данных конфигурации ATA.|
|Средства обнаружения|Эти компоненты выявляют подозрительные действия и аномальное поведение пользователей в сети, используя алгоритмы машинного обучения и детерминированные правила.|
|Консоль ATA|Этот компонент используется для настройки решения ATA и отслеживания подозрительных сетевых действий, обнаруженных этим решением. Консоль ATA не зависит от службы центра ATA и будет работать даже после ее остановки, если связь с базой данных не потеряна.|
При определении числа центров ATA, которые необходимо развернуть в сети, учитывайте следующее:

-   Один центр ATA может отслеживать лишь один лес Active Directory. При наличии нескольких лесов Active Directory для каждого из них требуется по крайней мере один центр ATA.

-    При очень крупных развертываниях Active Directory одного центра ATA может быть недостаточно для обработки всего трафика из контроллеров домена. В этом случае потребуется несколько центров ATA. Число центров ATA зависит от [планирования производительности решения](ata-capacity-planning.md).

## Шлюз ATA и упрощенный шлюз ATA

### Основные функции шлюза
**Шлюз ATA ** и **упрощенный шлюз ATA** выполняют одинаковые основные функции:

-   фиксация и проверка сетевого трафика контроллеров домена (трафик на зеркально отображенных портах для шлюза ATA и локальный трафик контроллера домена для упрощенного шлюза ATA); 

-   получение событий Windows с серверов SIEM или серверов системного журнала либо из контроллеров домена с помощью функции пересылки событий Windows;

-   получение данных о пользователях и компьютерах из домена Active Directory;

-   разрешение сетевых сущностей (пользователей, групп и компьютеров);

-   передача соответствующих данных в центр ATA;

-   мониторинг нескольких контроллеров домена из одного шлюза ATA или одного контроллера домена для упрощенного шлюза ATA.

Шлюз ATA получает сетевой трафик и события Windows из сети и обрабатывает их с помощью следующих основных компонентов:

|||
|-|-|
|Прослушиватель сети|Этот компонент фиксирует и анализирует сетевой трафик. Эта задача существенно нагружает ЦП, поэтому при настройке шлюза ATA и упрощенного шлюза ATA необходимо выполнить [предварительные требования для ATA](ata-prerequisites.md).|
|Прослушиватель событий|Этот компонент фиксирует и анализирует события Windows, пересылаемые из сервера SIEM в сети.|
|Средство чтения журнала событий Windows|Этот компонент считывает и анализирует события Windows, пересылаемые в журнал событий Windows шлюза ATA из контроллеров домена.|
|Транслятор сетевых операций | Этот компонент преобразует проанализированный трафик (сетевые операции) в логическое представление трафика ATA.
|Сопоставитель сущностей|Этот компонент принимает проанализированные данные (сетевой трафик и события) и разрешает их с помощью Active Directory, чтобы найти сведения об учетных записях и удостоверениях. Затем они сопоставляются с IP-адресами в этих данных. Сопоставитель сущностей проверяет заголовки пакетов и анализирует пакеты аутентификации для определения имен, свойств и удостоверений компьютеров. Затем он объединяет проанализированные пакеты аутентификации с данными в пакете.|
|Отправитель сущностей|Этот компонент отправляет проанализированные и сопоставленные данные в центр ATA.|

## Функции упрощенного шлюза ATA

Следующие компоненты и возможности работают по-разному в шлюзе ATA и упрощенном шлюзе ATA.

-   **Синхронизатор домена-кандидат**<br>
Шлюз синхронизатора домена отвечает за своевременную синхронизацию всех сущностей из определенного домена Active Directory (аналогичный механизм используется для репликации в контроллерах домена). В списке синхронизаторов домена случайным образом выбирается один шлюз. <br><br>
Если синхронизатор находится в автономном режиме более 30 минут, его заменяет другой кандидат. Если для конкретного домена синхронизатор домена недоступен, ATA не сможет своевременно синхронизировать сущности и изменения в них. Однако это решение будет оперативно получать новые сущности по мере их обнаружения в отслеживаемом трафике. 
<br>Если синхронизатор домена недоступен и требуется сущность, с которой не связан трафик, результаты поиска будут пусты.<br><br>
По умолчанию все шлюзы ATA подходят в качестве потенциальных синхронизаторов.<br><br>
Так как все упрощенные шлюзы ATA, скорее всего, развертываются на сайтах филиалов и на небольших контроллерах домена, они по умолчанию не рассматриваются в качестве потенциальных синхронизаторов.


-   **Ограничения ресурсов**<br>
Упрощенный шлюз ATA содержит компонент мониторинга, который оценивает доступный объем вычислительных ресурсов и памяти на контроллере домена, в котором он выполняется. Мониторинг выполняется каждые 10 секунд. При этом также осуществляется динамическое обновление квоты использования ресурсов ЦП и памяти для упрощенного шлюза ATA. Благодаря этому в любой момент времени на контроллере домена доступно по крайней мере 15 % свободных вычислительных ресурсов и ресурсов памяти.<br><br>
Независимо от операций, выполняемых на контроллере домена, в результате всегда освобождаются ресурсы, чтобы обеспечить непрерывную работу основных функций контроллера домена.<br><br>
Если это приводит к нехватке ресурсов упрощенного шлюза ATA, отслеживается только часть трафика, а на странице работоспособности появится оповещение мониторинга "Dropped port mirrored network traffic" (Сетевой трафик зеркально отображенных портов сброшен).

В таблице ниже приведен пример контроллера домена с достаточным количеством вычислительных ресурсов для больших квот, чем нужны в данный момент, чтобы обеспечить мониторинг всего трафика:

||||||
|-|-|-|-|-|
|Active Directory (Lsass.exe)|Упрощенный шлюз ATA (Microsoft.Tri.Gateway.exe)|Разное (другие процессы) |Квота упрощенного шлюза ATA|Сброс шлюза|
|30 %|20 %|10 %|45 %|Нет|

Если Active Directory требуются дополнительные вычислительные ресурсы, квота для упрощенного шлюза ATA сокращается. В следующем примере упрощенному шлюзу ATA требуется больше ресурсов, чем выделено квотой. Поэтому он сбрасывает некоторый трафик (выполняется мониторинг только части трафика):

||||||
|-|-|-|-|-|
|Active Directory (Lsass.exe)|Упрощенный шлюз ATA (Microsoft.Tri.Gateway.exe)|Разное (другие процессы) |Квота упрощенного шлюза ATA|Выполняется ли сброс шлюза|
|60 %|15 %|10 %|15 %|Да|



## Компоненты сети
Для работы с ATA требуется настроить следующие компоненты:

### Зеркальное отображение портов
При использовании шлюзов ATA необходимо настроить зеркальное отображение портов для контроллеров домена, которые будут отслеживаться, и указать шлюз ATA в качестве места назначения с помощью физических или виртуальных коммутаторов. Кроме того, можно использовать перехватчик трафика. Решение ATA будет работать, если мониторинг выполняется только для некоторых контроллеров домена, однако эффективность обнаружения будет ниже.

Хотя при зеркальном отображении портов шлюз ATA получает весь зеркально отображенный сетевой трафик контроллера домена, для анализа в центр ATA отправляется лишь небольшой объем данных о трафике в сжатом виде.

Контроллеры домена и шлюзы ATA могут быть как физическими, так и виртуальными. Дополнительные сведения см. в статье [Настройка зеркального отображения портов](/advanced-threat-analytics/deploy-use/configure-port-mirroring).


### События
Для повышения эффективности обнаружения атак Pass-the-Hash, атак методом подбора и атак с использованием honeytoken решению ATA требуется доступ к событию 4776 из журнала событий Windows. Обеспечить передачу сведений об этом событии на шлюз ATA можно двумя способами — путем настройки прослушивания событий SIEM в шлюзе ATA или пересылки событий Windows.

-   Настройка прослушивания событий SIEM в шлюзе ATA <br>Настройте пересылку определенных событий Windows из системы SIEM в ATA. ATA поддерживает несколько поставщиков SIEM. Дополнительные сведения см. в статье [Настройка сбора данных о событиях](/advanced-threat-analytics/deploy-use/configure-event-collection).

-   Настройка пересылки событий Windows<br>Чтобы обеспечить отправку сведений о событиях в ATA, можно также настроить пересылку сведений о событиях Windows 4776 из контроллеров домена на шлюз ATA. Это целесообразно, если у вас нет SIEM или ваша версия SIEM в настоящее время не поддерживается в ATA. Дополнительные сведения о пересылке событий Windows в ATA см. в разделе [Настройка пересылки событий Windows](/advanced-threat-analytics/deploy-use/configure-event-collection#configuring-windows-event-forwarding).

## См. также
- [Предварительные требования для ATA](ata-prerequisites.md)
- [Планирование производительности ATA](ata-capacity-planning.md)
- [Настройка сбора данных о событиях](/advanced-threat-analytics/deploy-use/configure-event-collection)
- [Настройка пересылки событий Windows](/advanced-threat-analytics/deploy-use/configure-event-collection#configuring-windows-event-forwarding)
- [Обязательно ознакомьтесь с форумом ATA.](https://social.technet.microsoft.com/Forums/security/home?forum=mata)




<!--HONumber=Jun16_HO4-->


