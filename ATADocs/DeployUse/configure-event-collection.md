---
title: "Настройка сбора событий в Advanced Threat Analytics | Документация Майкрософт"
description: "Описание вариантов настройки сбора событий с помощью ATA"
keywords: 
author: rkarlin
ms.author: rkarlin
manager: mbaldwin
ms.date: 1/23/2017
ms.topic: get-started-article
ms.prod: 
ms.service: advanced-threat-analytics
ms.technology: 
ms.assetid: 3f0498f9-061d-40e6-ae07-98b8dcad9b20
ms.reviewer: bennyl
ms.suite: ems
translationtype: Human Translation
ms.sourcegitcommit: 6fddbbae0a0734834a21975c7690e06ac28dc64d
ms.openlocfilehash: e31e3b8a94c8beef22be2f06ecaeb89545b3f62d
ms.lasthandoff: 02/21/2017


---

*Область применения: Advanced Threat Analytics версии 1.6 и 1.7*



# <a name="configure-event-collection"></a>Настройка сбора данных о событиях
Чтобы улучшить возможности обнаружения вторжений, ATA требуется доступ к событиям 4776 из журнала событий Windows. Эти данные могут передаваться на шлюз ATA двумя способами: путем настройки шлюза ATA на получение событий с SIEM, либо путем [настройки пересылки событий Windows](#configuring-windows-event-forwarding).

## <a name="event-collection"></a>Сбор данных о событиях
Помимо сбора и анализа входящего и исходящего сетевого трафика с контроллеров домена ATA может использовать событие Windows 4776 для улучшенного обнаружения атак типа Pass-the-Hash. Оно может быть получено от вашего SIEM или в случае настройки переадресации событий Windows на вашем контроллере домена. Собранные события предоставляют ATA дополнительные данные, которые невозможно получить через сетевой трафик контроллера домена.

### <a name="siemsyslog"></a>Система SIEM/системный журнал
Для обработки ATA данных с сервера системного журнала необходимо выполнить следующие действия:

-   Выполните настройку серверов шлюза ATA на прослушивание и прием событий, перенаправляемых с сервера SIEM или системного журнала.
> [!NOTE]
> ATA прослушивает только IPv4, но не IPv6. 
-   Выполните настройку сервера SIEM или системного журнала на пересылку определенных событий на шлюз ATA.

> [!IMPORTANT]
> -   Не выполняйте пересылку всех данных системного журнала на шлюз ATA.
> -   ATA поддерживает трафик UDP с сервера SIEM или системного журнала.

Подробности о настройке пересылки событий на другой сервер см. в документации по серверу SIEM или системному журналу. 

### <a name="windows-event-forwarding"></a>Пересылка событий Windows
Если сервер SIEM или системный журнал отсутствуют, настройку контроллеров домена Windows можно выполнить таким образом, чтобы АТА выполнял сбор и анализ событий 4776 с журнала событий Windows. События 4776 с журнала событий Windows содержат информацию о проверках подлинности NTLM.

## <a name="configuring-the-ata-gateway-to-listen-for-siem-events"></a>Настройка прослушивания событий SIEM в шлюзе ATA

1.  В разделе настройки ATA на вкладке "События" включите **Syslog** и нажмите **Сохранить**.

    ![Разрешите использование образа UDP для прослушивания системного журнала](media/ATA-enable-siem-forward-events.png)

2.  Выполните настройку сервера SIEM или системного журнала таким образом, чтобы события с идентификатором 4776 от журнала событий Windows направлялись на один из шлюзов ATA. Дополнительные сведения о настройке SIEM — см. справку в Интернете; об особых требованиях к форматированию каждого SIEM сервера — см. варианты технической поддержки.

### <a name="siem-support"></a>Поддержка SIEM
ATA поддерживает события SIEM в следующих форматах:  

#### <a name="rsa-security-analytics"></a>Аналитика безопасности RSA
&lt;Заголовок системного журнала&gt;RsaSA\n2015-May-19 09:07:09\n4776\nMicrosoft-Windows-Security-Auditing\nSecurity\XXXXX.subDomain.domain.org.il\nYYYYY$\nMMMMM \n0x0

-   Заголовок системного журнала необязателен.

-   Между всеми полями должен стоять символ-разделитель "\n".

-   Поля в порядке очередности:

    1.  Постоянное значение RsaSA (должно появиться).

    2.  Метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение желательно представлять в миллисекундах.

    3.  Код события Windows

    4.  Имя поставщика событий Windows

    5.  Имя журнала событий Windows

    6.  Имя компьютера, получающего событие (в данном случае контроллера домена)

    7.  Имя пользователя, подлинность которого проверяется

    8.  Имя исходного узла

    9. Код результата NTLM

-   Поскольку порядок важен, в сообщении не должно быть ничего другого.

#### <a name="hp-arcsight"></a>HP Arcsight
CEF:0|Microsoft|Microsoft Windows||Microsoft-Windows-Security-Auditing:4776|Контроллер домена попытался проверить учетные данные для учетной записи.|Low| externalId=4776 cat=Security rt=1426218619000 shost=KKKKKK dhost=YYYYYY.subDomain.domain.com duser=XXXXXX cs2=Security cs3=Microsoft-Windows-Security-Auditing cs4=0x0 cs3Label=EventSource cs4Label=Reason or Error Code

-   Должно соответствовать определению протокола.

-   Отсутствует заголовок системного журнала.

-   Заголовок определения (часть, разделенная вертикальной линией) должен существовать (как указано в протоколе).

-   В _расширении_ должны присутствовать следующие ключи:

    -   externalId = код события Windows

    -   rt = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки нам). Важно! Значение желательно представлять в миллисекундах.

    -   cat = имя журнала событий Windows

    -   shost = имя исходного узла

    -   dhost = имя компьютера, получающего событие (в данном случае контроллера домена)

    -   duser = имя пользователя, подлинность которого проверяется

-   Для _расширения_ порядок представления неважен

-   Для следующих двух полей следует назначить отдельный ключ и метку ключа:

    -   "EventSource"

    -   "Reason or Error Code" = код результата NTLM

#### <a name="splunk"></a>Splunk
&lt;Заголовок системного журнала&gt;\r\nEventCode=4776\r\nLogfile=Security\r\nSourceName=Microsoft-Windows-Security-Auditing\r\nTimeGenerated=20150310132717.784882-000\r\ComputerName=YYYYY\r\nMessage=

Компьютер попытался проверить учетные данные для учетной записи.

Пакет проверки подлинности:              MICROSOFT_AUTHENTICATION_PACKAGE_V1_0

Учетная запись входа: администратор

Исходная рабочая станция:       SIEM

Код ошибки:         0x0

-   Заголовок системного журнала необязателен.

-   Между всеми обязательными полями стоит символ-разделитель "\r\n".

-   Поля имеют формат ключ = значение.

-   Наличие следующих ключей и их значений обязательно:

    -   EventCode = код события Windows

    -   Logfile = имя журнала событий Windows

    -   SourceName = имя поставщика событий Windows

    -   TimeGenerated = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

    -   ComputerName = имя исходного узла

    -   Message = исходный текст события Windows

-   Ключ сообщения и его значение должны быть в конце.

-   Для пар ключ=значение порядок представления неважен.

#### <a name="qradar"></a>QRadar
QRadar активирует сбор данных о событиях через агента. Если сбор данных происходит с помощью агента, то формат времени представляется без указания миллисекунд. Так как ATA требуются данные о миллисекундах, необходимо настроить в QRadar сбор данных о событиях Windows без агента. Дополнительные сведения см. в статье QRadar: Agentless Windows Events Collection using the MSRPC Protocol (QRadar: сбор данных о событиях Windows без агента с помощью протокола MSRPC) ([http://www-01.ibm.com/support/docview.wss?uid=swg21700170](http://www-01.ibm.com/support/docview.wss?uid=swg21700170 ").")

    <13>Feb 11 00:00:00 %IPADDRESS% AgentDevice=WindowsLog AgentLogFile=Security Source=Microsoft-Windows-Security-Auditing Computer=%FQDN% User= Domain= EventID=4776 EventIDCode=4776 EventType=8 EventCategory=14336 RecordNumber=1961417 TimeGenerated=1456144380009 TimeWritten=1456144380009 Message=The computer attempted to validate the credentials for an account. Authentication Package: MICROSOFT_AUTHENTICATION_PACKAGE_V1_0 Logon Account: Administrator Source Workstation: HOSTNAME Error Code: 0x0

Необходимо задать следующие сведения в полях:

- тип агента для сбора данных;
- имя поставщика журнала событий Windows;
- источник журнала событий Windows;
- полное доменное имя контроллера домена;
- Код события Windows

TimeGenerated — это метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

Message — это исходный текст события Windows.

Между парами "ключ-значение" должен быть разделитель \t.

>[!NOTE] 
> Использование WinCollect для сбора данных о событиях Windows не поддерживается.

## <a name="configuring-windows-event-forwarding"></a>Настройка пересылки событий Windows

### <a name="wef-configuration-for-ata-gateways-with-port-mirroring"></a>Настройка пересылки событий Windows для шлюза ATA с зеркалированием портов

Когда вы настроите зеркалирование портов от контроллеров домена на шлюз ATA, выполните приведенные ниже инструкции, чтобы осуществлять пересылку событий Windows с помощью настройки "инициировано источником". Это один из возможных способов пересылки событий Windows. 

**Шаг 1. Добавление учетной записи сетевой службы в группу читателей журнала событий для домена** 

В этом сценарии предполагается, что шлюз ATA входит в домен.

1.    Откройте раздел "Пользователи и компьютеры Active Directory", перейдите в папку **Builtin** и дважды щелкните группу **Читатели журнала событий**. 
2.    Выберите пункт **Участники**.
4.    Если в этом списке нет элемента **Сетевая служба**, нажмите кнопку **Добавить** и введите имя **Сетевая служба** в поле **Введите имена выбираемых объектов**. Щелкните **Проверить имена** и дважды нажмите **ОК**. 

Обратите внимание, что после добавления **Сетевой службы** в группу **Читатели журнала событий** необходимо перезагрузить контроллеры домена, чтобы изменения вступили в силу.

**Шаг 2. Создание на контроллерах домена политики для изменения параметра "Настроить конечный диспетчер подписки"** 
> [!Note] 
> Вы можете настроить групповую политику для этих параметров, а затем применять ее к каждому контроллеру домена, контролируемому шлюзом ATA. Описанные ниже действия изменяют локальную политику контроллера домена.     

1.    Выполните следующую команду на каждом контроллере домена: *winrm quickconfig*.
2.  В командной строке введите *gpedit.msc*.
3.    Раскройте элементы **Конфигурация компьютера > Административные шаблоны > Компоненты Windows > Пересылка событий**.

 ![Изображения редактора локальной групповой политики](media/wef 1 local group policy editor.png)

4.    Дважды щелкните **Настроить конечный диспетчер подписки**.
   
    1.    Выберите значение **Включено**.
    2.    В разделе **Параметры** щелкните **Показать**.
    3.    В поле **SubscriptionManagers** введите следующее значение и нажмите кнопку **ОК**: *Server=http://<fqdnATAGateway>:5985/wsman/SubscriptionManager/WEC,Refresh=10* (Например, Server=http://atagateway9.contoso.com:5985/wsman/SubscriptionManager/WEC,Refresh=10)
 
   ![Изображение настройки целевой подписки](media/wef 2 config target sub manager.png)
   
    5.    Нажмите кнопку **ОК**.
    6.    В командной строке с повышенными привилегиями введите команду *gpupdate /force*. 

**Шаг 3. Выполнение действий на сервере шлюза ATA** 

1.    Откройте командную строку с повышенными привилегиями и введите *wecutil qc*
2.    Откройте средство **просмотра событий**. 
3.    Щелкните правой кнопкой мыши **Подписки** и выберите **Создать подписки**. 

   1.    Введите имя и описание для подписки. 
   2.    В параметре **Журнал назначения** должно быть выбрано значение **Перенаправленные события**. Чтобы шлюз ATA мог прочитать события, для журнала назначения следует указать **Перенаправленные события**. 
   3.    Выберите **Инициировано исходным компьютером** и нажмите **Выбор групп компьютеров**.
        1.    Щелкните **Добавить компьютер в домен**.
        2.    Введите имя контроллера домена в поле **Введите имена выбираемых объектов**. Щелкните **Проверить имена** и нажмите кнопку **ОК**. 
       
        ![Изображение средства просмотра событий](media/wef3 event viewer.png)
   
        
        3.    Нажмите кнопку **ОК**.
   4.    Щелкните **Выбрать события**.

        1. Щелкните **По журналу** и выберите **Журнал безопасности**.
        2. В поле **Includes/Excludes Event ID** (Включить/исключить идентификаторы событий) введите значение **4776** и нажмите **OK**. 

 ![Изображение фильтра запросов](media/wef 4 query filter.png)

   5.    Щелкните правой кнопкой мыши созданную подписку и выберите **Состояние выполнения**, чтобы проверить, есть ли проблемы с состоянием. 
   6.    Через несколько минут убедитесь, что событие 4776 отображается в списке пересланных событий на шлюзе ATA.


### <a name="wef-configuration-for-the-ata-lightweight-gateway"></a>Настройка пересылки событий Windows для упрощенного шлюза ATA
Если вы установили на контроллеры домена упрощенный шлюз ATA, можно настроить на контроллере домена пересылку событий на самого себя. Выполните следующие действия, чтобы настроить пересылку событий Windows с использованием упрощенного шлюза ATA. Это один из возможных способов пересылки событий Windows.  

**Шаг 1. Добавление учетной записи сетевой службы в группу читателей журнала событий для домена** 

1.    Откройте раздел "Пользователи и компьютеры Active Directory", перейдите в папку **Builtin** и дважды щелкните группу **Читатели журнала событий**. 
2.    Выберите пункт **Участники**.
3.    Если в этом списке нет элемента **Сетевая служба**, нажмите кнопку **Добавить** и введите имя **Сетевая служба** в поле **Введите имена выбираемых объектов**. Щелкните **Проверить имена** и дважды нажмите **ОК**. 

**Шаг 2. Выполнение действий на контроллере домена после установки упрощенного шлюза ATA** 

1.    Откройте командную строку с повышенными привилегиями и введите *winrm quickconfig*, затем *wecutil qc*. 
2.    Откройте средство **просмотра событий**. 
3.    Щелкните правой кнопкой мыши **Подписки** и выберите **Создать подписки**. 

   1.    Введите имя и описание для подписки. 
   2.    В параметре **Журнал назначения** должно быть выбрано значение **Перенаправленные события**. Чтобы шлюз ATA мог прочитать события, в качестве журнала назначения следует указать "Перенаправленные события".

        1.    Выберите **Инициировано сборщиком** и нажмите **Выбор компьютеров**. Щелкните **Добавить компьютер в домен**.
        2.    Введите имя контроллера домена в поле **Введите имена выбираемых объектов**. Щелкните **Проверить имена** и нажмите кнопку **ОК**.

            ![Изображение свойств подписки](media/wef 5 sub properties computers.png)

        3.    Нажмите кнопку **ОК**.
   3.    Щелкните **Выбрать события**.

        1.    Щелкните **По журналу** и выберите **Журнал безопасности**.
        2.    В поле **Includes/Excludes Event ID** (Включить/исключить идентификаторы событий) введите значение *4776* и нажмите **OK**. 

![Изображение фильтра запросов](media/wef 4 query filter.png)


  4.    Щелкните правой кнопкой мыши созданную подписку и выберите **Состояние выполнения**, чтобы проверить, есть ли проблемы с состоянием. 

> [!Note] 
> Чтобы параметры вступили в силу, следует перезагрузить контроллер домена. 

Через несколько минут убедитесь, что событие 4776 отображается в списке пересланных событий на шлюзе ATA.



Подробности см. в статье [Настройка компьютеров для пересылки и сбора событий](https://technet.microsoft.com/library/cc748890)

## <a name="see-also"></a>См. также
- [Установка ATA](install-ata-step1.md)
- [Ознакомьтесь с форумом ATA](https://social.technet.microsoft.com/Forums/security/home?forum=mata)

