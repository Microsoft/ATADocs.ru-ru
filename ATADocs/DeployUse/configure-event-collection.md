---
title: "Настройка сбора данных о событиях | Microsoft ATA"
description: "Описание вариантов настройки сбора событий с помощью ATA"
keywords: 
author: rkarlin
manager: stevenpo
ms.date: 04/28/2016
ms.topic: get-started-article
ms.prod: identity-ata
ms.service: advanced-threat-analytics
ms.technology: security
ms.assetid: 3f0498f9-061d-40e6-ae07-98b8dcad9b20
ms.reviewer: bennyl
ms.suite: ems
translationtype: Human Translation
ms.sourcegitcommit: a5c7163bc7b1989672e587bfb4fa6a65cd4e3751
ms.openlocfilehash: 6876339e1303438da10a56e23d8eb831cc17050c


---

# Настройка сбора данных о событиях
Чтобы улучшить возможности обнаружения вторжений, ATA требуется доступ к событиям 4776 из журнала событий Windows. Эти данные могут передаваться на шлюз ATA двумя способами: путем настройки шлюза ATA на получение событий с SIEM, либо путем [настройки пересылки событий Windows](#configuring-windows-event-forwarding).

## Сбор данных о событиях
Помимо сбора и анализа входящего и исходящего сетевого трафика с контроллеров домена ATA может использовать событие Windows 4776 для улучшенного обнаружения атак типа Pass-the-Hash. Его можно получить из системы SIEM или путем установки пересылки событий Windows с контроллера домена. Собранные события предоставляют ATA дополнительные данные, которые невозможно получить через сетевой трафик контроллера домена.

### Система SIEM/системный журнал
Для обработки ATA данных с сервера системного журнала необходимо выполнить следующие действия:

-   Выполните настройку одного из серверов шлюза ATA на прослушивание и прием событий, перенаправляемых с сервера SIEM или системного журнала.

-   Выполните настройку сервера SIEM или системного журнала на пересылку определенных событий на шлюз ATA.

> [!IMPORTANT]
> -   Не выполняйте пересылку всех данных системного журнала на шлюз ATA.
> -   ATA поддерживает трафик UDP с сервера SIEM или системного журнала.

Подробности о настройке пересылки событий на другой сервер см. в документации по серверу SIEM или системному журналу. 

### Пересылка событий Windows
Если сервер SIEM или системный журнал отсутствуют, настройку контроллеров домена Windows можно выполнить таким образом, чтобы АТА выполнял сбор и анализ событий 4776 с журнала событий Windows. События 4776 с журнала событий Windows содержат информацию о проверках подлинности NTLM.

## Настройка прослушивания событий SIEM в шлюзе ATA

1.  В разделе настройки параметров шлюза ATA включите функцию **прослушивания UDP системного журнала**.

    Установите IP-адрес прослушивания, как показано на рисунке ниже. По умолчанию используется порт 514.

    ![Разрешите использование образа UDP для прослушивания системного журнала](media/ATA-enable-siem-forward-events.png)

2.  Выполните настройку сервера SIEM или системного журнала таким образом, чтобы события 4776 с журнала событий Windows направлялись на IP-адрес, выбранный выше. Дополнительные сведения о настройке SIEM — см. справку в Интернете; об особых требованиях к форматированию каждого SIEM сервера — см. варианты технической поддержки.

### Поддержка SIEM
ATA поддерживает события SIEM в следующих форматах:

#### Аналитика безопасности RSA
&lt;Заголовок системного журнала&gt;RsaSA\n2015-May-19 09:07:09\n4776\nMicrosoft-Windows-Security-Auditing\nSecurity\XXXXX.subDomain.domain.org.il\nYYYYY$\nMMMMM \n0x0

-   Заголовок системного журнала необязателен.

-   Между всеми полями должен стоять символ-разделитель "\n".

-   Поля в порядке очередности:

    1.  Постоянное значение RsaSA (должно появиться).

    2.  Метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение желательно представлять в миллисекундах.

    3.  Код события Windows

    4.  Имя поставщика событий Windows

    5.  Имя журнала событий Windows

    6.  Имя компьютера, получающего событие (в данном случае контроллера домена)

    7.  Имя пользователя, подлинность которого проверяется

    8.  Имя исходного узла

    9. Код результата NTLM

-   Поскольку порядок важен, в сообщении не должно быть ничего другого.

#### HP Arcsight
CEF:0|Microsoft|Microsoft Windows||Microsoft-Windows-Security-Auditing:4776|Контроллер домена попытался проверить учетные данные для учетной записи.|Low| externalId=4776 cat=Security rt=1426218619000 shost=KKKKKK dhost=YYYYYY.subDomain.domain.com duser=XXXXXX cs2=Security cs3=Microsoft-Windows-Security-Auditing cs4=0x0 cs3Label=EventSource cs4Label=Reason or Error Code

-   Должно соответствовать определению протокола.

-   Отсутствует заголовок системного журнала.

-   Заголовок определения (часть, разделенная вертикальной линией) должен существовать (как указано в протоколе).

-   В _расширении_ должны присутствовать следующие ключи:

    -   externalId = код события Windows

    -   rt = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки нам). Важно! Значение желательно представлять в миллисекундах.

    -   cat = имя журнала событий Windows

    -   shost = имя исходного узла

    -   dhost = имя компьютера, получающего событие (в данном случае контроллера домена)

    -   duser = имя пользователя, подлинность которого проверяется

-   Для _расширения_ порядок представления неважен

-   Для следующих двух полей следует назначить отдельный ключ и метку ключа:

    -   "EventSource"

    -   "Reason or Error Code" = код результата NTLM

#### Splunk
&lt;Заголовок системного журнала&gt;\r\nEventCode=4776\r\nLogfile=Security\r\nSourceName=Microsoft-Windows-Security-Auditing\r\nTimeGenerated=20150310132717.784882-000\r\ComputerName=YYYYY\r\nMessage=

Компьютер попытался проверить учетные данные для учетной записи.

Пакет проверки подлинности:              MICROSOFT_AUTHENTICATION_PACKAGE_V1_0

Учетная запись входа: администратор

Исходная рабочая станция:       SIEM

Код ошибки:         0x0

-   Заголовок системного журнала необязателен.

-   Между всеми обязательными полями стоит символ-разделитель "\r\n".

-   Поля имеют формат ключ = значение.

-   Наличие следующих ключей и их значений обязательно:

    -   EventCode = код события Windows

    -   Logfile = имя журнала событий Windows

    -   SourceName = имя поставщика событий Windows

    -   TimeGenerated = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Важно! Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

    -   ComputerName = имя исходного узла

    -   Message = исходный текст события Windows

-   Ключ сообщения и его значение должны быть в конце.

-   Для пар ключ=значение порядок представления неважен.

#### QRadar
QRadar активирует сбор данных о событиях через агента. Если сбор данных происходит с помощью агента, то формат времени представляется без указания миллисекунд. Так как ATA требуются данные о миллисекундах, необходимо настроить в QRadar сбор данных о событиях Windows без агента. Дополнительные сведения см. в статье QRadar: Agentless Windows Events Collection using the MSRPC Protocol (QRadar: сбор данных о событиях Windows без агента с помощью протокола MSRPC) ([http://www-01.ibm.com/support/docview.wss?uid=swg21700170](http://www-01.ibm.com/support/docview.wss?uid=swg21700170 ").")

    <13>Feb 11 00:00:00 %IPADDRESS% AgentDevice=WindowsLog AgentLogFile=Security Source=Microsoft-Windows-Security-Auditing Computer=%FQDN% User= Domain= EventID=4776 EventIDCode=4776 EventType=8 EventCategory=14336 RecordNumber=1961417 TimeGenerated=1456144380009 TimeWritten=1456144380009 Message=The computer attempted to validate the credentials for an account. Authentication Package: MICROSOFT_AUTHENTICATION_PACKAGE_V1_0 Logon Account: Administrator Source Workstation: HOSTNAME Error Code: 0x0

Необходимо задать следующие сведения в полях:

- тип агента для сбора данных;
- имя поставщика журнала событий Windows;
- источник журнала событий Windows;
- полное доменное имя контроллера домена;
- Код события Windows

TimeGenerated — это метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки на ATA). Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

Message — это исходный текст события Windows.

Между парами "ключ-значение" должен быть разделитель \t.

>[!NOTE] 
> Использование WinCollect для сбора данных о событиях Windows не поддерживается.

## Настройка пересылки событий Windows
При отсутствии сервера SIEM контроллеры домена можно настроить таким образом, чтобы события 4776 журнала событий Windows направлялись непосредственно на один из шлюзов ATA.

1.  Выполните вход на все контроллеры домена и компьютеры шлюзов АТА, используя доменную учетную запись с правами администратора.
2. Убедитесь в том, что все контроллеры домена и шлюзы ATA, к которым вы подключаетесь, присоединены к одному домену.
3.  В командной строке с повышенными привилегиями на каждом контроллере домена введите:
```
winrm quickconfig
```
4.  В командной строке с повышенными привилегиям шлюза АТА введите:
```
wecutil qc
```
5.  В разделе **Пользователи и компьютеры Active Directory** каждого контроллера домена перейдите в папку **Builtin** и дважды щелкните группу **Читатели журнала событий**.<br>
![wef_ad_eventlogreaders](media/wef_ad_eventlogreaders.png)<br>
Щелкните правой кнопкой мыши и выберите пункт **Свойства**. Во вкладке **Члены группы** добавьте учетную запись компьютера каждого шлюза ATA.
![wef_ad event log reader popup](media/wef_ad-event-log-reader-popup.png)
6.  На шлюзе ATA откройте средство просмотра событий и щелкните правой кнопкой мыши на **Подписки**, после чего выберите **Создать подписку**.  

    а. В разделе **Тип подписки и исходные компьютеры** щелкните на **Выбрать компьютеры**, после чего добавьте контроллеры домена и проверьте возможность подключения.
    ![wef_subscription prop](media/wef_subscription-prop.png)

    b. В разделе **Собираемые события** щелкните **Выбор событий**. Выберите **По журналу**, прокрутите вниз и выберите **Безопасность**. Затем в разделе **Включение или исключение кодов событий** введите **4776**.<br>
    ![wef_4776](media/wef_4776.png)

    в. В разделе **Изменение учетной записи или настройка дополнительных параметров** щелкните **Дополнительно**.
Установите значение **HTTP** для **протокола** и **5985** — для **порта**.<br>
    ![wef_http](media/wef_http.png)

7.  [Необязательно] Для установки более короткого интервала опроса установите на шлюзе ATA значение пульса в 5 секунд.
    wecutil ss <CollectionName>/cm:custom wecutil ss <CollectionName> /hi:5000

8. На странице настройки шлюза ATA включите функцию **Пересылки событий Windows**.

> [!NOTE]
> При использовании этой функции шлюз АТА будет выполнять поиск событий с журнала перенаправленных событий Windows, которые были направлены на него с контроллеров домена.

Подробности см. в статье [Настройка компьютеров для пересылки и сбора событий](https://technet.microsoft.com/library/cc748890)

## См. также
- [Установка ATA](install-ata.md)
- [Обязательно ознакомьтесь с форумом ATA.](https://social.technet.microsoft.com/Forums/security/en-US/home?forum=mata)



<!--HONumber=Jul16_HO3-->


