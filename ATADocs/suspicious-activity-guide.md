---
title: Руководство по работе с подозрительными действиями в ATA
description: В этой статье приводится список подозрительных действий, обнаруживаемых Advanced Threat Analytics (ATA), и меры, предпринимаемые в их отношении.
keywords: ''
author: shsagir
ms.author: shsagir
manager: shsagir
ms.date: 04/03/2019
ms.topic: conceptual
ms.prod: advanced-threat-analytics
ms.technology: ''
ms.assetid: 1fe5fd6f-1b79-4a25-8051-2f94ff6c71c1
ms.reviewer: bennyl
ms.suite: ems
ms.openlocfilehash: aa89bb10e60c103af1684ae7a2d2dc5f4227bb92
ms.sourcegitcommit: c7c0a4c9f7507f3e8e0f219798ed7d347c03e792
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90912235"
---
# <a name="advanced-threat-analytics-suspicious-activity-guide"></a>Руководство по подозрительным действиям, обнаруживаемым Advanced Threat Analytics | Документация Майкрософт

[!INCLUDE [Banner for top of topics](includes/banner.md)]

[!INCLUDE [Rebranding notice](includes/rebranding.md)]

На основе анализа любое подозрительное действие можно классифицировать как одно из следующих:

- **Истинный положительный результат**: вредоносное действие, обнаруженное ATA.

- **Некритическое истинное положительное значение**: действие, обнаруженное ATA, которое является реальным, но не вредоносным, например тестом на проникновение.
- **Ложное срабатывание**: ложное оповещение, означающее, что действие не произошло.

Дополнительные сведения о работе с оповещениями ATA см. в статье [Обработка подозрительных действий](working-with-suspicious-activities.md).

Для получения вопросов или отзывов обратитесь к команде ATA по адресу [ATAEval@microsoft.com](mailto:ATAEval@microsoft.com) .

## <a name="abnormal-modification-of-sensitive-groups"></a>аномальное изменение привилегированных групп;

**Описание**

Злоумышленники добавляют пользователей в группы с высоким уровнем привилегий. Это позволяет им получить доступ к большему числу ресурсов и добиться постоянного присутствия в системе. Обнаружение предполагает профилирование действий по изменению группы пользователей и отправку оповещений при обнаружении аномального изменения привилегированной группы. Служба АТА выполняет профилирование непрерывно. Оповещение активируется не чаще одного раза в месяц для каждого контроллера домена.

Определение привилегированных групп в ATA см. в разделе [Привилегированные группы](working-with-ata-console.md#sensitive-groups).

Обнаружение зависит от событий, прошедшие [Аудит на контроллерах домена](configure-event-collection.md).
Чтобы убедиться, что контроллеры домена выполняют аудит нужных действий, используйте средство, на которое есть ссылка в записи блога [ATA Auditing (AuditPol, Advanced Audit Settings Enforcement, Lightweight Gateway Service discovery)](https://aka.ms/ataauditingblog) (Аудит ATA: AuditPol, использование расширенных параметров аудита, обнаружение службы упрощенного шлюза).

**Исследование**

1. Проверьте, правомерно ли изменение группы. </br>Нередко возникающие изменения группы, которые не были известны как «обычные», могут вызвать предупреждение, которое будет считаться ненадежным истинным положительным.

1. Если добавленный объект — это учетная запись пользователя, проверьте действия, выполненные с ее помощью, после добавления пользователя в группу администраторов. Перейдите на страницу пользователя в ATA, чтобы получить дополнительный контекст. Проверьте, обнаружены ли любые другие подозрительные действия, связанные с учетной записью, до или после ее добавления. Загрузите отчет об **изменениях привилегированной группы**, чтобы просмотреть сведения о других изменениях, реализованных в то же время, а также о пользователях, которые их внесли.

**Исправление**

Максимально сократите число пользователей, которым разрешено изменять привилегированные группы.

Настройте [privileged Access Management для Active Directory](/microsoft-identity-manager/pam/privileged-identity-management-for-active-directory-domain-services) , если это применимо.

## <a name="broken-trust-between-computers-and-domain"></a>Нарушение доверия между доменом и компьютерами

> [!NOTE]
> Оповещение о нарушении доверия между доменом и компьютерами устарело. Оно отображается только в версиях ATA, предшествующих 1.9.

**Описание**

Нарушение доверия означает, что такие компьютеры не удовлетворяют требованиям к безопасности Active Directory. и являются уязвимыми для злоумышленников. Поэтому такое состояние считается серьезным нарушением безопасности и соответствия требованиям. Если в течение суток для учетной записи было зарегистрировано более пяти неудачных попыток проверки подлинности Kerberos, для этого обнаружения в ATA активируется оповещение.

**Исследование**

Есть ли у пользователей домена возможность выполнить вход на компьютер под подозрением?
- Если есть, вы можете пропустить раздел исправления соответствующей проблемы.

**Исправление**

При необходимости повторно присоедините компьютер к домену или сбросьте его пароль.

## <a name="brute-force-attack-using-ldap-simple-bind"></a>Атака методом подбора с помощью простой привязки LDAP

**Описание**

>[!NOTE]
> Основное различие между **подозрительными неудачными попытками проверки подлинности** и таким обнаружением заключается в том, что при таком обнаружении ATA может определить, использовались ли разные пароли.

При атаке методом подбора злоумышленник пытается пройти проверку подлинности с помощью разных паролей учетных записей, пока не получится подобрать правильный пароль по крайней мере к одной учетной записи. Когда злоумышленник находит пароль, он может войти в систему с помощью соответствующей учетной записи.

При обнаружении такой проблемы активируется оповещение, если ATA обнаруживает значительное количество проверок подлинности с простой привязкой. Это может быть либо *горизонтально* , с небольшим набором паролей для нескольких пользователей. или *по вертикали "* с большим набором паролей только для нескольких пользователей; или любое сочетание этих двух вариантов.

**Исследование**

1. При наличии нескольких учетных записей щелкните **Сведения о загрузке**, чтобы просмотреть список в виде электронной таблицы Excel.

1. Щелкните оповещение, чтобы перейти на его выделенную страницу. Проверьте количество успешных попыток входа. Попытки отображаются в виде **угаданных учетных записей** в правой части инфографики. При наличии успешных попыток входа проверьте, использовались ли обычно какие-либо из **угаданных учетных записей** на исходном компьютере Если да, **отмените** вывод оповещения о подозрительной активности.

1. При отсутствии **угаданных учетных записей** проверьте, использовались ли обычно какие-либо из **атакованных учетных записей** на исходном компьютере. Если да, **отмените** вывод оповещения о подозрительной активности.

**Исправление**

[Сложные и длинные пароли](/windows/device-security/security-policy-settings/password-policy) обеспечивают необходимый первый уровень безопасности от атак методом подбора.

## <a name="encryption-downgrade-activity"></a>Переход на более слабое шифрование

**Описание**

Переход на более слабый уровень шифрования — это метод ослабления защиты, предоставляемой протоколом Kerberos. Он заключается в понижении уровня шифрования разных полей протокола, для которых обычно предусмотрено самое надежное шифрование. Поле, зашифрованное на слабом уровне, может быть легкой целью для автономных атак путем подбора. При различных методах атаки используется слабое шифрование Kerberos. При обнаружении такой проблемы ATA анализирует типы шифрования Kerberos, используемые компьютерами и пользователями, и отправляет оповещения, если используется более слабый шифр, который является (1) нестандартным для исходного компьютера или пользователя и (2) соответствует известным методам атак.

Существует три типа обнаружения:

1. Вредоносные программы, использующие мастер-ключи, которые выполняются на контроллерах домена и позволяют проходить проверку подлинности в домене с помощью любой учетной записи, не зная ее пароля. Такие вредоносные программы часто используют слабые алгоритмы шифрования для хэширования паролей пользователей на контроллере домена. При таком обнаружении метод шифрования сообщения KRB_ERR из контроллера домена к учетной записи с запросом билета понижен в уровне в сравнении с ранее установленным поведением.

1. Golden Ticket. В оповещении [Golden Ticket](#golden-ticket) метод шифрования поля TGT в сообщении TGS_REQ (запрос на обслуживание) с исходного компьютера понижен в уровне в сравнении с ранее установленным поведением. Это никоим образом не связано с временными аномалиями (как в других случаях обнаружения Golden Ticket). Кроме того, отсутствует запрос на проверку подлинности Kerberos, связанный с предыдущим запросом на обслуживание, обнаруженным ATA.

1. Overpass-the-Hash. Злоумышленник может воспользоваться слабо зашифрованным похищенным хэшем для создания строго зашифрованного билета с помощью запроса Kerberos AS. При таком обнаружении тип шифрования сообщения AS_REQ из исходного компьютера понижен в уровне в сравнении с ранее установленным поведением (это значит, что компьютером использовался ключ AES).

**Исследование**

Сначала проверьте описание предупреждения, чтобы узнать, с какими из перечисленных выше трех типов обнаружения вы работаете. Чтобы получить дополнительные сведения, скачайте электронную таблицу Excel.

1. Использование мастер-ключа. Проверить заражение контроллеров домена вредоносными программами, использующими мастер-ключи, можно с помощью [сканера, созданного группой разработчиков ATA](https://gallery.technet.microsoft.com/Aorato-Skeleton-Key-24e46b73). Если сканер обнаружит вредоносные программы на одном или нескольких контроллерах домена, то этот результат будет рассматриваться, как истинно положительный.
1. Золотой билет — в электронной таблице Excel перейдите на вкладку **Сетевая активность** . Вы увидите, что соответствующее поле с понижением по отношению к **типу шифрования билет запроса**и **типы шифрования, поддерживаемые исходным компьютером** , содержат более надежные методы шифрования.
    1. Проверьте исходный компьютер и учетную запись или, если есть несколько исходных компьютеров и учетных записей, проверьте, есть ли у них что-то общее (например, все сотрудники отдела маркетинга используют конкретное приложение, которое может вызвать срабатывание предупреждения). В некоторых случаях редко используемое пользовательское приложение применяет для аутентификации слабое шифрование. Проверьте наличие таких настраиваемых приложений на исходном компьютере. Если они имеются, то такой результат можно рассматривать как истинно положительный, а вывод оповещений этого типа **подавить**.
    1. Проверьте ресурс, к которому обращаются эти билеты. Если есть один ресурс, к которому они обращаются, проверьте его, убедитесь, что это допустимый ресурс, к которому они обращаются. Также убедитесь, что целевой ресурс поддерживает более стойкие методы шифрования. Это можно проверить в Active Directory по атрибуту `msDS-SupportedEncryptionTypes` для учетной записи службы ресурсов.
1. Overpass-The-hash — в электронной таблице Excel перейдите на вкладку **Сетевая активность** . Вы увидите, что соответствующее поле с понижением по **времени является зашифрованным типом шифрования timestamp** , а **типы шифрования, поддерживаемые исходным компьютером** , содержат более надежные методы шифрования.
    1. в некоторых случаях это предупреждение может быть активировано, когда пользователь входит в систему с помощью SmartCards, если конфигурация смарт-карты была изменена недавно. Проверьте наличие подобных изменений в соответствующих учетных записях. Если они имеются, то такой результат можно рассматривать как истинно положительный, а вывод оповещений этого типа **подавить**.
    1. Проверьте ресурс, к которому обращаются эти билеты. Если есть один ресурс, к которому они обращаются, проверьте его, убедитесь, что это допустимый ресурс, к которому они обращаются. Также убедитесь, что целевой ресурс поддерживает более стойкие методы шифрования. Это можно проверить в Active Directory по атрибуту `msDS-SupportedEncryptionTypes` для учетной записи службы ресурсов.

**Исправление**

1. При использовании мастер-ключа удалите вредоносную программу. См. дополнительные сведения об [анализе вредоносной программы, использующей мастер-ключи](https://www.virusbulletin.com/virusbulletin/2016/01/paper-digital-bian-lian-face-changing-skeleton-key-malware).

1. Golden Ticket. Следуйте инструкциям, описанным в разделе о подозрительных действиях [Golden Ticket](#golden-ticket).
    Кроме того, поскольку для создания золотого билета требуются права администратора домена, реализуйте [перед ними рекомендации по хэшированию](https://www.microsoft.com/download/details.aspx?id=36036).

1. Overpass-the-Hash. Если соответствующая учетная запись не конфиденциальная, сбросьте ее пароль. Таким образом злоумышленник не сможет создать билеты Kerberos из хэша пароля, но имеющиеся билеты можно по-прежнему использовать до истечения их срока действия. Если это конфиденциальная учетная запись, следует рассмотреть возможность повторной настройки учетной записи KRBTGT в два раза, как в подозрительном мероприятии. Учтите, что такой сброс приведет к тому, что все билеты Kerberos в этом домене станут недействительными. Дополнительные сведения см. в записи блога о [скриптах сброса пароля учетной записи KRBTGT, доступных клиентам](https://blogs.microsoft.com/microsoftsecure/2015/02/11/krbtgt-account-password-reset-scripts-now-available-for-customers/). См. также раздел Использование [Сброс пароля или ключей учетной записи KRBTGT

    Tool] ( https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51) . Так как это способ перемещения по сети, следуйте [рекомендациям касательно атак типа Pass-the-Hash](https://www.microsoft.com/download/details.aspx?id=36036).

## <a name="honeytoken-activity"></a>Действие Honeytoken

**Описание**

Учетные записи Honeytoken представляют собой фиктивные учетные записи-ловушки, предназначенные для определения и отслеживания вредоносных действий в сети, которые выполняются с их использованием. Эти учетные записи не должны использоваться, так как их имена известны злоумышленникам (например, SQL-Admin). Любая, связанная с ними, активность скорее всего указывает на вредоносное действие.

Дополнительные сведения об учетных записях Honeytoken см. в статье [Установка ATA. Шаг 7](install-ata-step7.md).

**Исследование**

1. Проверьте, проходил ли владелец исходного компьютера проверку подлинности с помощью учетной записи Honeytoken и метода, описанного на странице о подозрительной активности (например, Kerberos, LDAP, NTLM).

1. Перейдите на страницу профиля исходного компьютера и просмотрите, какие другие учетные записи прошли проверку подлинности. Узнайте у владельцев этих учетных записей, использовали ли они учетные записи Honeytoken.

1. Возможно, это был неинтерактивный вход, поэтому не забудьте проверить приложения и сценарии, запущенные на исходном компьютере.

Если после выполнения шагов 1 – 3 нет свидетельства о небезопасном использовании, предположим, что это вредоносная проблема.

**Исправление**

Убедитесь, что учетные записи Honeytoken используются только согласно своему назначению. В противном случае вы получите большое количество оповещений.

## <a name="identity-theft-using-pass-the-hash-attack"></a>Кража удостоверения с помощью атаки Pass-the-Hash

**Описание**

Pass-the-Hash — это способ перемещения по сети, при котором злоумышленники крадут хэш NTLM пользователя из одного компьютера и используют его для получения доступа к другому.

**Исследование**

Проверьте, использовался ли хэш на компьютере, который принадлежит целевому пользователю или регулярно им используется. Если да, то это ложное срабатывание. Если нет, то это может быть вредоносным действием.

**Исправление**

1. Если соответствующая учетная запись не конфиденциальная, сбросьте пароль к ней. Сброс пароля не позволит злоумышленнику создать билеты Kerberos из хэша пароля. Существующие билеты можно по-прежнему использовать до истечения срока их действия.

1. Если же учетная запись конфиденциальная, следует дважды сбросить данные учетной записи KRBTGT, как и при подозрительном действии типа Golden Ticket. Учтите, что такой сброс приведет к тому, что все билеты Kerberos в этом домене станут недействительными. См. запись блога о [скриптах для сброса пароля к учетной записи KRBTGT, доступных клиентам](https://blogs.microsoft.com/microsoftsecure/2015/02/11/krbtgt-account-password-reset-scripts-now-available-for-customers/), а также сведения об использовании [средства сброса пароля или ключей к учетной записи KRBTGT](https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51). Так как эти действия обычно представляют боковое смещение, следуйте [рекомендациям по защите от атак типа Pass-the-Hash](https://www.microsoft.com/download/details.aspx?id=36036).

## <a name="identity-theft-using-pass-the-ticket-attack"></a>Кража удостоверения с помощью атаки Pass-the-Ticket

**Описание**

Атака Pass-the-Ticket — это способ перемещения по сети, при котором злоумышленники похищают билет Kerberos с одного компьютера и используют его для доступа к другому с помощью его повторного использования. При таком обнаружении видно, что билет Kerberos используется на нескольких компьютерах.

**Исследование**

1. Нажмите кнопку **Сведения о загрузке**, чтобы просмотреть полный список вовлеченных IP-адресов. Проверьте, является ли IP-адрес одного или нескольких компьютеров частью подсети, выделенной из пула DHCP недостаточного размера, например VPN или WiFi. Проверьте, является ли IP-адрес общим (например, совместно используемым с устройством NAT). Если да, то это ложное срабатывание.

1. Проверьте, имеется ли настраиваемое приложение, которое перенаправляет билеты от имени пользователей. Если да, вы столкнулись с неопасным истинно положительным действием.

**Исправление**

1. Если соответствующая учетная запись не конфиденциальная, сбросьте ее пароль. Сброс пароля не позволит злоумышленнику создать билеты Kerberos из хэша пароля. Все существующие билеты можно по-прежнему использовать до истечения срока их действия.

1. Если это конфиденциальная учетная запись, следует рассмотреть возможность повторной настройки учетной записи KRBTGT в два раза, как в подозрительном мероприятии. Учтите, что такой сброс приведет к тому, что все билеты Kerberos в этом домене станут недействительными. Ознакомьтесь с записью блога о [скриптах для сброса пароля к учетной записи KRBTGT, доступных клиентам](https://blogs.microsoft.com/microsoftsecure/2015/02/11/krbtgt-account-password-reset-scripts-now-available-for-customers/), а также с использованием [средства сброса пароля или ключей к учетной записи KRBTGT](https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51).  Так как это способ перемещения по сети, следуйте лучшим [рекомендациям касательно атак типа Pass-the-Hash](https://www.microsoft.com/download/details.aspx?id=36036).

## <a name="kerberos-golden-ticket-activity"></a>Действие с использованием Golden Ticket в Kerberos<a name="golden-ticket"></a>

**Описание**

Злоумышленники с правами администратора домена могут скомпрометировать [учетную запись KRBTGT](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn745899(v=ws.11)#Sec_KRBTGT). Злоумышленники могут использовать учетную запись KRBTGT, чтобы создать билет на получение билетов Kerberos (TGT), с помощью которого можно получить доступ к любому ресурсу. Срок действия билета можно установить произвольно. Такой фиктивный билет TGT называется билетом Golden Ticket и позволяет злоумышленникам проникнуть в сеть и добиться постоянного присутствия в ней.

Если билет на получение билетов Kerberos используется дольше, чем разрешено политикой безопасности [Максимальный срок жизни билета пользователя](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/jj852169(v=ws.11)), для такого обнаружения активируется оповещение.

**Исследование**

1. Проверьте, вносились ли какие-либо изменения (в течение последних нескольких часов) в параметре **максимального времени жизни пользовательского билета** в групповой политике. Если да, **закройте** оповещение (так как это ложное срабатывание).

1. Проверьте, включил ли шлюз ATA в это оповещение виртуальную машину. Если да, проверьте, давно ли ее вывели из сохраненного состояния. Если да, **закройте** это оповещение.

1. В случае противоположных ответов на вопросы выше вы, вероятнее всего, столкнулись с вредоносными программами.

**Исправление**

Несколько раз меняйте пароль билета на получение билетов Kerberos (KRBTGT), как описано в записи блога о [скриптах для сброса пароля к учетной записи KRBTGT, доступных клиентам](https://blogs.microsoft.com/microsoftsecure/2015/02/11/krbtgt-account-password-reset-scripts-now-available-for-customers/) с помощью [средства сброса пароля или ключей к учетной записи KRBTGT](https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51). Учтите, что такой сброс приведет к тому, что все билеты Kerberos в этом домене станут недействительными.
Кроме того, поскольку для создания золотого билета требуются права администратора домена, реализуйте [перед ними рекомендации по хэшированию](https://www.microsoft.com/download/details.aspx?id=36036).

## <a name="malicious-data-protection-private-information-request"></a>Вредоносный запрос конфиденциальных сведений для защиты данных

**Описание**

API защиты данных (DPAPI) используется Windows для защиты паролей, сохраненных браузерами, зашифрованными файлами, а также других конфиденциальных данных. На контроллерах домена хранится резервный главный ключ, с помощью которого можно расшифровать все секретные данные, зашифрованные DPAPI на компьютерах Windows, присоединенных к домену. Злоумышленники могут использовать этот главный ключ для расшифровки любых секретных данных, защищенных DPAPI на всех компьютерах, присоединенных к домену.
При таком обнаружении оповещение активируется, когда для извлечения резервного главного ключа используется DPAPI.

**Исследование**

1. Проверьте, используется ли исходным компьютером утвержденный организацией сканер безопасности с расширенными параметрами для Active Directory.

1. Если да и это нормальная практика, подозрительное действие можно **закрыть и исключить**.

1. Если да, но это аномальное действие, подозрительное действие необходимо **закрыть.

**Исправление**

Чтобы использовать DPAPI, злоумышленнику требуются права администратора домена. Следуйте [рекомендациям касательно атак типа Pass-the-Hash](https://www.microsoft.com/download/details.aspx?id=36036).

## <a name="malicious-replication-of-directory-services"></a>Вредоносная репликация служб каталогов

**Описание**

Репликация Active Directory — это процесс, посредством которого изменения, внесенные на одном из контроллеров домена, синхронизируются с остальными контроллерами в домене. При получении необходимых разрешений злоумышленники могут инициировать запрос репликации, что позволит им получить данные, хранящиеся в Active Directory, в том числе хэши паролей.

При таком обнаружении оповещение активируется, когда инициирован запрос репликации с компьютера, не являющегося контроллером домена.

**Исследование**

1. Проверьте, является ли компьютер, с которого инициирован запрос репликации, контроллером домена (например, новым контроллером домена, у которого возникли проблемы с репликацией). Если это так, **закройте** подозрительную активность.
1. Проверьте, могла ли на соответствующем компьютере выполняться репликация данных из Active Directory (например, Azure AD Connect). Если да, **закройте и исключите** подозрительную активность.
1. Щелкните имя исходного компьютера или учетную запись, чтобы перейти на страницу профиля. Проверьте, что происходило с ними во время репликации, обращая особое внимание на необычные действия. Отследите, кто выполнял вход и к каким ресурсам обращался этот пользователь.

**Исправление**

Проверьте следующие разрешения:

- репликация изменений каталога;

- репликация всех изменений каталога.

Дополнительные сведения см. в статье [Предоставление доменным службам Active Directory разрешений для синхронизации профилей в SharePoint Server 2013](/SharePoint/administration/user-profile-service-administration).
Вы можете использовать [сканер списков управления доступом Active Directory](/archive/blogs/pfesweplat/take-control-over-ad-permissions-and-the-ad-acl-scanner-tool) или создать скрипт Windows PowerShell для определения того, у кого в домене есть эти разрешения.

## <a name="massive-object-deletion"></a>Массовое удаление объектов

**Описание**

В некоторых сценариях злоумышленники используют атаку типа "отказ в обслуживании" (DoS), а не только похищают сведения. Удаление большого числа учетных записей — один из способов совершения DoS-атаки.

Если удалено более 5 % всех учетных записей, для такого обнаружения активируется оповещение. Для этого обнаружения требуется доступ к контейнеру удаленных элементов с правами на чтение.
Дополнительные сведения о настройке в контейнере удаленных объектов разрешений только на чтение см. в инструкциях по **изменению разрешений для контейнера удаленных объектов** из руководства по [просмотру или установке разрешений для объекта каталога](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc816824(v=ws.10)).

**Исследование**

Просмотрите список удаленных учетных записей и определите, было ли оправданным такое масштабное удаление.

**Исправление**

Отзовите разрешения на удаление учетных записей в Active Directory у пользователей. Дополнительные сведения см. в статье о [просмотре или установке разрешений на доступ к объекту каталога](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc816824(v=ws.10)).

## <a name="privilege-escalation-using-forged-authorization-data"></a>Атака, направленная на повышение привилегий с использованием поддельных данных авторизации

**Описание**

Известные уязвимости в предыдущих версиях Windows Server позволяют злоумышленникам использовать сертификат атрибута привилегий (PAC). PAC — это поле в билете Kerberos, которое содержит данные об авторизации пользователя (в Active Directory это членство в группах). С его помощью злоумышленники могут получить дополнительные привилегии.

**Исследование**

1. Щелкните оповещение, чтобы перейти на страницу с подробными сведениями.

1. Проверьте, применено ли к конечному компьютеру (в столбце **ACCESSED**) исправление MS14-068 (контроллер домена) или MS11-013 (сервер)? Если да, **закройте** подозрительную активность (так как это ложное срабатывание).

1. Если исправление не было применено, выполняются ли на исходном компьютере (в столбце **FROM**) ОС или приложение, способные изменять PAC? Если да, **подавите** подозрительную активность (так как она неопасная истинно положительная).

1. Если ответ на оба вопроса отрицательный, действие предположительно является вредоносным.

**Исправление**

Убедитесь, что все контроллеры домена с операционными системами вплоть до Windows Server 2012 R2 установлены с [KB3011780](https://support.microsoft.com/help/2496930/ms11-013-vulnerabilities-in-kerberos-could-allow-elevation-of-privilege) , а все рядовые серверы и контроллеры домена до 2012 R2 обновлены с помощью KB2496930. Дополнительные сведения см. в статьях, посвященных ["серебряному" сертификату атрибута привилегий](/security-updates/SecurityBulletins/2011/ms11-013) и [подделке сертификата атрибута привилегий](/security-updates/SecurityBulletins/2014/ms14-068).

## <a name="reconnaissance-using-account-enumeration"></a>Разведывательная атака с использованием перечисления учетных записей.

**Описание**

В разведывательной атаке путем перечисления учетных записей злоумышленник использует словарь с тысячами имен пользователей или такие средства, как KrbGuess, чтобы попытаться угадать имена пользователей в вашем домене. Он создает запросы Kerberos с различными именами, пытаясь найти имя, которое будет в вашем домене допустимым. Если имя пользователя угадано верно, злоумышленник получит ошибку Kerberos **Требуется предварительная проверка подлинности**, а не **Неизвестный субъект безопасности**.

При обнаружении этой атаки ATA может определить, откуда пришла атака, сколько всего было попыток угадывания и сколько было успешных совпадений. Если неизвестных пользователей слишком много, ATA распознает это как подозрительное действие.

**Исследование**

1. Щелкните оповещение, чтобы открыть страницу подробностей.

    1. Должен ли этот хост-компьютер опрашивать контроллер домена на предмет того, существуют ли учетные записи (например, серверы Exchange Server)?

1. Запущен ли на хост-компьютере сценарий или приложение, которые могут вызывать такие действия?

    Если ответ на любой из этих вопросов положительный, **закройте** подозрительное действие (это неопасное истинно положительное действие) и исключите хост-компьютер из списка подозрительных действий.

1. Вы можете скачать электронную таблицу Excel с подробными данными оповещения, в которой представлен удобный для анализа список всех попыток угадывания учетных записей, разделенный по существующим и несуществующим записям. Если несуществующие учетные записи в электронной таблице выглядят знакомыми, возможно, это отключенные учетные записи сотрудников, уволившихся из компании. В этом случае перебор вряд ли осуществляется по словарю. Скорее всего, приложение или сценарий проверяет, какие учетные записи все еще существуют в Active Directory, что значит, что выполняется неопасное истинно положительное действие.

1. Если имена в основном незнакомые, проверьте, совпали ли попытки угадывания с именами существующих учетных записей в Active Directory? Если совпадений нет, попытка была безрезультатной, но рекомендуем отслеживать оповещение на случай, если в нем со временем появится новая информация.

1. Если какая-либо попытка угадывания совпадает с существующими именами учетных записей, злоумышленник знает о существовании учетных записей в вашей среде и может попытаться использовать атаку методом подбора, чтобы получить доступ к домену с помощью обнаруженных имен пользователей. Проверьте угаданные имена учетных записей на предмет других подозрительных действий. Проверьте, не являются ли совпавшие учетные записи конфиденциальными.

**Исправление**

[Сложные и длинные пароли](/windows/device-security/security-policy-settings/password-policy) обеспечивают необходимый первый уровень безопасности от атак методом подбора.

## <a name="reconnaissance-using-directory-services-queries"></a>Рекогносцировка с использованием запросов к службам каталогов

**Описание**

Перечисление служб каталогов — это прием, используемый злоумышленниками для сопоставления структуры каталогов и определения привилегированных учетных записей для дальнейших этапов атаки. Одним из методов, используемых для запроса каталога для такого сопоставления, является протокол SAM-R.

При таком обнаружении в течение первого месяца после развертывания ATA оповещения будут отсутствовать. Во время периода обучения ATA определяет, какие запросы SAM-R соответствуют каждому компьютеру. Это могут быть групповые или отдельные запросы конфиденциальной учетной записи.

**Исследование**

1. Щелкните оповещение, чтобы открыть страницу подробностей. Просмотрите выполненные запросы (например, администраторов предприятия или администраторов), а также, как они завершились — успешно или сбоем.

1. Проверьте, выполнены ли эти запросы с исходного соответствующего компьютера.

1. Если да и оповещение обновилось, **отмените** вывод оповещения о подозрительной активности.

1. Если да, но вы хотите запретить это действие, **закройте** подозрительную активность.

1. При наличии сведений о задействованной учетной записи: эти запросы должны выполняться этой учетной записью или же эта учетная запись обычно входит в систему на исходном компьютере?

   - Если да и оповещение обновилось, **отмените** вывод оповещения о подозрительной активности.

   - Если да, но вы хотите запретить это действие, **закройте** подозрительную активность.

   - В случае противоположных ответов на все вопросы выше вы, вероятнее всего, столкнулись с вредоносными программами.

1. Если сведения о соответствующей учетной записи отсутствуют, можно перейти к конечной точке и проверить, с помощью какой учетной записи был выполнен вход во время вывода предупреждения.

**Исправление**

Используйте [средство SAMRi10](https://gallery.technet.microsoft.com/SAMRi10-Hardening-Remote-48d94b5b), чтобы усилить защиту среды от этого метода атаки.
Если средство неприменимо к контроллеру домена:
1. Запущено ли на компьютере средство сканирования уязвимостей?
1. Проверьте, являются ли атакуемые конкретные запрашиваемые пользователи и группы привилегированными или значимыми учетными записями (например, генеральным директором, финансовым директором, руководителем ИТ-отдела и т. д.).  Если да, просмотрите другие действия в конечной точке и ведите наблюдение за компьютерами, на которых регистрируются запрошенные учетные записи, так как они, скорее всего, представляют собой целевые объекты скрытой угрозы.

## <a name="reconnaissance-using-dns"></a>Разведывательная атака с использованием DNS.

**Описание**

На DNS-сервере содержится схема всех компьютеров, IP-адресов и служб в сети. Эта информация используется злоумышленниками для определения структуры сети и выявления подходящих компьютеров для проведения последующих этапов атаки.

Протокол DNS предполагает несколько типов запросов. ATA обнаруживает запрос AXFR (передачи), исходящий от серверов, которые не являются серверами DNS.

**Исследование**

1. Проверьте, является ли исходный компьютер (**источник**) DNS-сервером. Если да, то это, скорее всего, ложное срабатывание. Щелкните оповещение, чтобы открыть страницу подробностей, и проверьте соответствующие сведения. В таблице в разделе **запроса** просмотрите запрошенные домены. Проверьте, имеются ли домены. Если да, **закройте** подозрительную активность (так как это ложное срабатывание). Кроме того, откройте UDP-порт 53 между шлюзом ATA и исходным компьютером, чтобы предотвратить дальнейшие ложные срабатывания.
1. Проверьте, запущен ли на исходном компьютере сканер безопасности. Если да, **исключите** СУЩНОСТИ в ATA непосредственно с помощью кнопки **Закрыть и исключить** или с помощью страницы **исключения** (в разделе **Конфигурация** — доступно для администраторов ATA).
1. Если на все эти вопросы вы получили отрицательные ответы, продолжайте исследование на компьютере-источнике. Щелкните компьютер-источник, чтобы перейти на страницу профиля. Проверьте, что происходило во время запроса, обращая особое внимание на необычные действия. Отследите, кто выполнял вход и к каким ресурсам обращался этот пользователь.

**Исправление**

Чтобы защитить внутренний DNS-сервер от разведывательных атак с использованием DNS, можно отключить передачу зоны или ограничить ее только определенными IP-адресами. Дополнительные сведения об ограничении зонных передач см. в разделе [Ограничение передачи зон](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ee649273(v=ws.10)).
Настройка передачи зоны — одна из задач контрольного списка при [защите DNS-серверов от внутренних и внешних атак](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc770432(v=ws.11)).

## <a name="reconnaissance-using-smb-session-enumeration"></a>Рекогносцировка с использованием перечисления сеансов SMB

**Описание**

Перечисление SMB позволяет злоумышленникам узнать, в какие системы пользователи недавно выполнили вход. Получив эти сведения, злоумышленники могут перемещаться по сети, чтобы далее получить доступ к определенной конфиденциальной учетной записи.

Если перечисление сеансов SMB выполняется для контроллера домена, для такого обнаружения активируется оповещение.

**Исследование**

1. Щелкните оповещение, чтобы открыть страницу подробностей. Просмотрите, с помощью каких учетных записей были выполнены действия и был ли получен доступ к другим учетным записям.

   - Проверьте, запущен ли на исходном компьютере какой-либо сканер безопасности. Если да, **закройте и исключите** подозрительную активность.

1. Просмотрите, какими именно пользователями выполнено действие. Проверьте, выполнили ли они вход на исходный компьютер стандартным образом или они являются администраторами, которые могут выполнять такие действия.

1. Если да и оповещение обновилось, **отмените** вывод оповещения о подозрительной активности.

1. Если да, но оповещение не должно обновляться, подозрительное действие нужно **закрыть**.

1. Если ответ на оба вопроса отрицательный, действие предположительно является вредоносным.

**Исправление**

Используйте [средство Net Cease](https://gallery.technet.microsoft.com/Net-Cease-Blocking-Net-1e8dcb5b), чтобы усилить защиту среды от атак этого типа.

## <a name="remote-execution-attempt-detected"></a>Обнаружение попытки удаленного выполнения

**Описание**

Злоумышленники, компрометирующие учетные данные администратора или использующие эксплойт нулевого дня, могут выполнять удаленные команды на контроллере домена. С их помощью они могут получать постоянный доступ, собирать данные, проводить атаки типа "отказ в обслуживании" (DOS) и выполнять другие действия. ATA обнаруживает удаленные подключения WMI и PSexec.

**Исследование**

1. Чаще всего это касается административных рабочих станций, а также сотрудников ИТ-отдела и учетных записей служб, выполняющих задачи администрирования на контроллерах домена. В таком случае при обновлении оповещения об удаленном выполнении задачи тем же администратором или на том же компьютере оповещение можно **проигнорировать**.
1. Есть ли разрешение у соответствующего компьютера на такое удаленное выполнение в контроллере домена?
   - Есть ли разрешение у соответствующей учетной записи на такое удаленное выполнение в контроллере домена?
   - Если ответ на оба вопроса имеет значение Да, **закройте** оповещение.
1. Если ответ на любой из вопросов отрицательный, действие является вредоносным. Попробуйте найти источник попытки, проверив профили компьютера и учетной записи. Щелкните имя исходного компьютера или учетную запись, чтобы перейти на страницу профиля. Проверьте, что происходило с ними во время попыток, обращая особое внимание на необычные действия. Отследите, кто выполнял вход и к каким ресурсам обращался этот пользователь.

**Исправление**

1. Ограничьте удаленный доступ к контроллерам домена с компьютеров, не относящихся к уровню 0.

1. Реализуйте [привилегированный доступ](/windows-server/identity/securing-privileged-access/securing-privileged-access), чтобы разрешить подключение к контроллерам домена с правами администратора только с защищенных компьютеров.

## <a name="sensitive-account-credentials-exposed--services-exposing-account-credentials"></a>Предоставление данных привилегированной учетной записи и предоставление учетных данных службами

> [!NOTE]
> Это подозрительное действие устарело и отображается только в версиях ATA, предшествующих 1.9. Сведения для ATA 1.9 и более поздних версий см. в разделе [Отчеты](reports.md).

**Описание**

Некоторые службы отправляют данные учетной записи в виде обычного текста. Такое бывает и в случае с привилегированными учетными записями. Злоумышленники, отслеживающие сетевой трафик, могут перехватить эти учетные данные и использовать их для вредоносных действий. Любой пароль в виде обычного текста для привилегированной учетной записи вызовет активацию оповещения, а в случае учетных записей, которые не являются привилегированными, оповещение активируется при отправке таких открытых паролей с помощью пяти или более разных учетных записей с одного исходного компьютера.

**Исследование**

Щелкните оповещение, чтобы открыть страницу подробностей. Просмотрите, данные каких учетных записей были предоставлены. При наличии нескольких таких учетных записей щелкните **Сведения о загрузке**, чтобы просмотреть список в виде электронной таблицы Excel.

Обычно на исходных компьютерах имеется сценарий или устаревшее приложение, использующее простую привязку LDAP.

**Исправление**

Проверьте конфигурацию исходных компьютеров и убедитесь в том, что на них не используется простая привязка LDAP. Вместо применения простой привязки LDAP вы можете использовать протокол LDAP SALS или LDAPS.

## <a name="suspicious-authentication-failures"></a>Подозрительные неудачные попытки проверки подлинности

**Описание**

При атаке методом подбора злоумышленник пытается пройти проверку подлинности с помощью разных паролей учетных записей, пока не получится подобрать правильный пароль по крайней мере к одной учетной записи. Когда злоумышленник находит пароль, он может войти в систему с помощью соответствующей учетной записи.

При таком обнаружении оповещение активируется при наличии нескольких попыток проверки подлинности с помощью Kerberos или NTLM, завершившихся сбоем. Это может быть обнаружение методом подбора по горизонтали (небольшой набор паролей для большого числа пользователей) или по вертикали (большой набор паролей для небольшого числа пользователей). Кроме того, может использоваться любое сочетание этих вариантов. Минимальный срок запуска оповещения составляет один месяц.

**Исследование**

1. Щелкните **сведения о загрузке**, чтобы просмотреть всю информацию в формате электронной таблицы Excel. Здесь вы получите следующие сведения:
   - Список учетных записей, подвергшихся атаке.
   - Список учетных записей, для которых попытки предположительно завершились успешной аутентификацией.
   - Если попытки аутентификации выполнялись через NTLM, вы увидите соответствующие события действий.
   - Если попытки аутентификации выполнялись через Kerberos, вы увидите соответствующее события сети.
1. Щелкните компьютер-источник, чтобы перейти на страницу профиля. Проверьте, что происходило с ними во время попыток, обращая особое внимание на необычные действия. Отследите, кто выполнял вход и к каким ресурсам обращался этот пользователь.
1. Если аутентификация выполнялась через NTLM и это предупреждение создано много раз, но у вас нет достаточных сведений о том, к какому серверу компьютер-источник пытался получить доступ, следует включить **аудит NTLM** на соответствующих контроллерах домена. Для этого включите событие 8004. Это событие аутентификации NTLM содержит сведения о компьютере-источнике, учетной записи пользователя и **сервере**, к которому выполнялся доступ. Выяснив, какой сервер выполнял проверку аутентификации, исследуйте данные об этом сервере, в частности события 4624 и другую информацию, чтобы отследить весь процесс аутентификации.

**Исправление**

[Сложные и длинные пароли](/windows/device-security/security-policy-settings/password-policy) обеспечивают необходимый первый уровень безопасности от атак методом подбора.

## <a name="suspicious-service-creation"></a>Создание подозрительных служб <a name="suspicious-service-creation"></a>

**Описание**

Злоумышленник пытаться запустить подозрительные служб в сети. Если на контроллере домена была создана новая служба, которая кажется подозрительной, ATA выводит оповещение. Это предупреждение зависит от события 7045, которое обнаруживается на каждом контроллере домена в области действия шлюза или упрощенного шлюза ATA.

**Исследование**

1. Если рассматриваемый компьютер является рабочей станцией администратора или на нем члены ИТ-команды и учетные записи службы выполняют административные задачи, это оповещение может быть ложноположительным, поэтому может потребоваться **заблокировать** его и при необходимости добавить в список исключений.

1. Данная служба распознается на этом компьютере?

   - Разрешено ли устанавливать эту службу с использованием рассматриваемой **учетной записи**?

   - При *утвердительном* ответе на оба вопроса **закройте** оповещение или добавьте его в список исключений.

1. Если ответ на любой вопрос равен « *нет*», то он должен считаться истинным положительным.

**Исправление**

- Включите на компьютерах домена доступ с меньшими привилегиями, чтобы создавать службы могли только определенные пользователи.

## <a name="suspicion-of-identity-theft-based-on-abnormal-behavior"></a>Подозрение на кражу идентификационных данных на основе аномального поведения

**Описание**

ATA анализирует поведение сущности для пользователей, компьютеров и ресурсов в течение трех недель. Модель поведения основана на следующем: компьютерах, на которые сущностями выполнен вход, ресурсах, к которым сущности запросили доступ, а также времени, затраченном на эти действия. ATA отправляет оповещение при отклонении от поведения сущности на основе алгоритмов машинного обучения.

**Исследование**

1. Проверьте могли ли эти действия выполняться соответствующим пользователем.

1. Рассматривайте следующие варианты, как потенциально ложные срабатывания: пользователь, вернувшийся из отпуска, ИТ-персонал, использующий дополнительный доступ, так как это часть их работы (например, во время пика обращений в службу поддержки в определенные дни недели), приложения удаленного рабочего стола. Если вы **закроете и исключите** оповещение, пользователь больше не будет рассматриваться при обнаружении.

**Исправление**

 Действия по исправлению проблемы зависят от причины аномального поведения. Например, при сканировании сети исходный компьютер должен быть отключен от сети (до получения разрешения).

## <a name="unusual-protocol-implementation"></a>Внедрение нестандартных протоколов.

**Описание**

Злоумышленники используют средства, реализующие различные протоколы (SMB, Kerberos, NTLM) нестандартными способами. Хотя этот тип сетевого трафика принимается Windows без каких-либо предупреждений, ATA может распознавать потенциально вредоносные цели. Это поведение указывает на применение таких методов, как Over-Pass-the-Hash, и эксплойтов, используемых усовершенствованными программами-шантажистами типа WannaCry.

**Исследование**

Определите нестандартный протокол. На временной шкале с подозрительными действиями щелкните нужное действие, чтобы открыть страницу со сведениями. Над стрелкой отобразится протокол: Kerberos или NTLM.

- **Kerberos.** Это оповещение часто активируется при подозрении на использование такого средства взлома, как Mimikatz, для атаки Overpass-the-Hash. Просмотрите, запущено ли на исходном компьютере приложение, реализующее собственный стек Kerberos, не соответствующий Kerberos RFC. Если это так, значит действие является неопасным истинно положительным и оповещение можно **закрыть**. Если оповещение остается активированным, но приложение выше запущено, вы можете **отменить** вывод оповещения.

- **NTLM.** Этот протокол может активироваться с помощью WannaCry или средств Metasploit, Medusa и Hydra.

Чтобы распознать атаку WannaCry, сделайте следующее:

1. Проверьте, используется ли на исходном компьютере такое средство взлома, как Metasploit, Medusa или Hydra.

1. Если эти средства не обнаружены, проверьте, запущено ли на исходном компьютере приложение, реализующее собственный стек SMB или NTLM.

1. Если нет, проверьте, вызвано ли это действиями WannaCry. Для этого запустите скрипт сканера WannaCry, например [этот сканер](https://github.com/apkjet/TrustlookWannaCryToolkit/tree/master/scanner), на исходном компьютере, где обнаружено подозрительное действие. Если сканер обнаружит, что компьютер заражен или уязвим, выполните диагностику обнаружения проблем, удалите вредоносные программы и установите защиту на уровне сети.

1. Даже если сценарий не обнаружит заражения или уязвимости, компьютер все равно может быть заражен, но атака SMBv1 может оставаться неактивной или же к компьютеру были применены исправления, повлиявшие на результат сканирования.

**Исправление**

Установите последние исправления на все компьютеры и все обновления для системы безопасности.

1. [Удалите SMBv1](https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/).

1. [Удалите WannaCry](https://support.microsoft.com/help/890830/remove-specific-prevalent-malware-with-windows-malicious-software-remo).

1. Данные на компьютере, контролируемом программой-шантажистом, иногда могут быть расшифрованы. Это возможно, только если пользователь не перезапустил или не выключил компьютер. Дополнительные сведения см. на странице обсуждения [программы-шантажиста WannaCry](https://answers.microsoft.com/en-us/windows/forum/windows_10-security/wanna-cry-ransomware/5afdb045-8f36-4f55-a992-53398d21ed07?auth=1).

>[!NOTE]
> Чтобы отключить оповещение о подозрительном действии, обратитесь в службу поддержки.

## <a name="related-videos"></a>Видео по теме

- [Join the Security Community](https://channel9.msdn.com/Shows/Microsoft-Security/Join-the-Security-Community) (Участие в сообществе безопасности)

## <a name="see-also"></a>См. также:

- [Сборник тренировочных заданий по реагированию на подозрительные действия ATA](https://aka.ms/ataplaybook)
- [Обязательно ознакомьтесь с форумом ATA.](https://social.technet.microsoft.com/Forums/security/home?forum=mata)
- [Обработка подозрительных действий](working-with-suspicious-activities.md)
