---
title: Настройка зеркального отображения портов при развертывании Microsoft Defender для удостоверений
description: Узнайте о вариантах зеркального отображения портов и их настройке для Microsoft Defender для удостоверений
keywords: ''
author: shsagir
ms.author: shsagir
manager: shsagir
ms.date: 10/26/2020
ms.topic: how-to
ms.collection: M365-security-compliance
ms.service: azure-advanced-threat-protection
ms.reviewer: itargoet
ms.suite: ems
ms.openlocfilehash: 479ca268e2db61bd1667005d2aa2a38603888f0b
ms.sourcegitcommit: f434dbff577d9944df18ca7533d026acdab0bb42
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/03/2020
ms.locfileid: "93276404"
---
# <a name="configure-port-mirroring"></a>Настройка зеркального отображения портов

[!INCLUDE [Rebranding notice](includes/rebranding.md)]

Сведения в этой статье относятся только к развертыванию автономных датчиков [!INCLUDE [Product long](includes/product-long.md)], а не датчиков [!INCLUDE [Product short](includes/product-short.md)].

> [!NOTE]
> Автономные датчики [!INCLUDE [Product short](includes/product-short.md)] не поддерживают сбор записей журнала трассировки событий Windows (ETW), которые предоставляют данные для нескольких обнаружений. Для полного охвата среды рекомендуется развернуть датчик [!INCLUDE [Product short](includes/product-short.md)].

Основным способом получения данных, используемых [!INCLUDE [Product short](includes/product-short.md)], является тщательный анализ пакетов входящего и исходящего сетевого трафика контроллеров домена. Чтобы предоставить [!INCLUDE [Product short](includes/product-short.md)] доступ к сетевому трафику, необходимо настроить зеркальное отображение портов или использовать точку доступа к терминалу сети.

**Зеркальное отображение портов** следует настроить в качестве **средства** получения сетевого трафика для каждого контроллера домена, который необходимо отслеживать. Как правило, чтобы настроить зеркальное отображение портов, следует привлечь специалистов по обслуживанию сети или группу виртуализации.
Дополнительные сведения см. в документации поставщика.

Контроллеры домена и автономные датчики [!INCLUDE [Product short](includes/product-short.md)] могут быть физическими или виртуальными. Ниже приведены распространенные технологии зеркального отображения портов и некоторые связанные рекомендации. Дополнительные сведения см. в документации по вашему коммутатору или серверу виртуализации. Изготовитель коммутатора может использовать другую терминологию.

**Switched Port Analyzer (SPAN)** — эта технология копирует сетевой трафик из одного или нескольких коммутируемых портов на другой коммутируемый порт на одном коммутаторе. Контроллеры домена и автономный датчик [!INCLUDE [Product short](includes/product-short.md)] должны быть подключены к одному физическому коммутатору.

**Remote Switch Port Analyzer (RSPAN)** — эта технология позволяет отслеживать сетевой трафик из исходных портов, распределенных по нескольким физическим коммутаторам. RSPAN копирует исходящий трафик в специальную виртуальную ЛС, настроенную для RSPAN. Необходимо настроить магистральные линии связи между этой виртуальной ЛС и другими вовлеченными коммутаторами. RSPAN работает на уровне 2.

**Encapsulated Remote Switch Port Analyzer (ERSPAN)** — это технология компании Cisco, которая работает на уровне 3. ERSPAN позволяет отслеживать трафик между коммутаторами, при этом магистральные линии связи для виртуальной ЛС не требуются. Для копирования отслеживаемого сетевого трафика эта технология использует общую инкапсуляцию маршрутов (Generic Routing Encapsulation, GRE). В настоящее время трафик ERSPAN не может поступать непосредственно в [!INCLUDE [Product short](includes/product-short.md)]. Чтобы направить трафик ERSPAN в [!INCLUDE [Product short](includes/product-short.md)], необходимо настроить коммутатор или маршрутизатор, который может декапсулировать исходящий трафик, в качестве пункта назначения для ERSPAN, где и выполнится декапсуляция. Затем настройте коммутатор или маршрутизатор для передачи декапсулированного трафика датчику [!INCLUDE [Product short](includes/product-short.md)], используя SPAN или RSPAN.

> [!NOTE]
> Если контроллер домена с зеркальным отображением портов подключен через глобальную сеть, убедитесь, что эта сеть может обрабатывать дополнительную нагрузку в виде трафика ERSPAN.
> [!INCLUDE [Product short](includes/product-short.md)] поддерживает мониторинг трафика только тогда, когда трафик достигает сетевого адаптера и контроллера домена одним и тем же образом. [!INCLUDE [Product short](includes/product-short.md)] не поддерживает мониторинг трафика, если он распределяется по различным портам.

## <a name="supported-port-mirroring-options"></a>Поддерживаемые варианты зеркального отображения портов

|Автономный датчик [!INCLUDE [Product short](includes/product-short.md)]|Контроллер домена|Рекомендации|
|---------------|---------------------|------------------|
|Виртуальная|Виртуальный на том же узле|Виртуальный коммутатор должен поддерживать зеркальное отображение портов.<br /><br />Перемещение одной из виртуальных машин на другой узел может нарушить зеркальное отображение портов.|
|Виртуальная|Виртуальный на других узлах|Убедитесь, что виртуальный коммутатор поддерживает такой сценарий.|
|Виртуальная|Физическая|Требуется выделенный сетевой адаптер, иначе [!INCLUDE [Product short](includes/product-short.md)] будет отслеживать весь исходящий и входящий трафик узла, в том числе трафик, отправляемый в облачный экземпляр [!INCLUDE [Product short](includes/product-short.md)].|
|Физическая|Виртуальная|Убедитесь, что виртуальный коммутатор поддерживает этот сценарий и конфигурацию зеркального отображения портов на физических коммутаторах в рамках этого сценария:<br /><br />Если виртуальный узел расположен на одном и том же физическом коммутаторе, необходимо настроить SPAN на уровне коммутатора.<br /><br />Если виртуальный узел расположен на другом коммутаторе, необходимо настроить RSPAN или ERSPAN&#42;.|
|Физическая|Физический на том же коммутаторе|Физический коммутатор должен поддерживать SPAN и зеркальное отображение портов.|
|Физическая|Физический на другом коммутаторе|Требуются физические коммутаторы, поддерживающие RSPAN или ERSPAN&#42;.|

&#42; ERSPAN поддерживается, только если декапсуляция выполняется до анализа трафика [!INCLUDE [Product short](includes/product-short.md)].

> [!NOTE]
> Время контроллеров домена и автономного датчика [!INCLUDE [Product short](includes/product-short.md)], к которым они подключаются, должно быть синхронизировано в пределах пяти минут.

**При работе с кластерами виртуализации:**

- Настройте сопоставление между контроллером домена и автономным датчиком [!INCLUDE [Product short](includes/product-short.md)] для каждого контроллера домена в кластере виртуализации на виртуальной машине с автономным датчиком [!INCLUDE [Product short](includes/product-short.md)]. Таким образом, при перемещении контроллера домена на другой узел в кластере автономный датчик [!INCLUDE [Product short](includes/product-short.md)] останется привязанным к нему. Такая конфигурация подходит при наличии нескольких контроллеров домена.

  > [!NOTE]
  > Если среда поддерживает преобразование виртуальной машины в виртуальную машину на других узлах (RSPAN), не нужно беспокоиться о сходстве.

- Чтобы правильно подобрать размеры автономного датчика [!INCLUDE [Product short](includes/product-short.md)] для мониторинга всех контроллеров домена, установите виртуальную машину на каждом узле виртуализации, а автономный датчик [!INCLUDE [Product short](includes/product-short.md)] — на каждом узле. Затем настройте каждый автономный датчик [!INCLUDE [Product short](includes/product-short.md)] для мониторинга всех контроллеров домена в кластере. Таким образом отслеживается каждый узел, на котором работают контроллеры домена.

Прежде чем установить автономный датчик [!INCLUDE [Product short](includes/product-short.md)], убедитесь, что настроенное зеркальное отображение портов работает надлежащим образом.

## <a name="see-also"></a>См. также

- [Настройка пересылки событий](configure-event-forwarding.md)
- [Посетите форум по [!INCLUDE [Product short](includes/product-short.md)].](https://aka.ms/MDIcommunity)
