---
title: Архитектура Azure Advanced Threat Protection | Документы Майкрософт
description: В этой статье описывается архитектура Azure Advanced Threat Protection (ATP).
keywords: ''
author: rkarlin
ms.author: rkarlin
manager: mbaldwin
ms.date: 7/4/2018
ms.topic: article
ms.prod: ''
ms.service: azure-advanced-threat-protection
ms.technology: ''
ms.assetid: 90f68f2c-d421-4339-8e49-1888b84416e6
ms.reviewer: itargoet
ms.suite: ems
ms.openlocfilehash: 3f99aff656f6eff67a4077817c761c7627511bb2
ms.sourcegitcommit: 40dbce8045f689376a50275fb12e3c5c32ca8092
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/04/2018
ms.locfileid: "37799187"
---
*Применяется к: Azure Advanced Threat Protection*


# <a name="azure-atp-architecture"></a>Архитектура Azure ATP
Архитектура Azure Advanced Threat Protection подробно представлена на следующей схеме:

![Схема топологии архитектуры Azure ATP](media/atp-architecture-topology.png)

Azure ATP отслеживает сетевой трафик контроллеров домена, используя зеркальное отображение портов на автономный датчик Azure ATP с помощью физических или виртуальных коммутаторов. При развертывании датчика Azure ATP непосредственно на контроллерах домена зеркальное отображение портов не требуется. Кроме того, Azure ATP может использовать события Windows (которые пересылаются непосредственно из контроллеров домена или сервера SIEM) и анализировать данные, связанные с атаками и угрозами. Azure ATP получает проанализированный трафик с автономного датчика Azure ATP и датчика Azure ATP. После этого выполняется профилирование, детерминированное обнаружение и запуск алгоритмов машинного обучения и анализа поведения. Это позволяет получить сведения о сети, выявить аномалии и сообщить о подозрительных действиях.

В этом разделе рассматривается процесс фиксации сетевого трафика и событий, а также подробно описаны функции основных компонентов ATP: автономного датчика Azure ATP, датчика Azure ATP (основные функции этих двух компонентов совпадают) и облачной службы Azure ATP. 

При установке непосредственно на контроллерах домена датчик обращается к требуемым журналам событий напрямую из контроллера домена. Когда датчик проанализирует эти журналы и сетевой трафик, Azure ATP отправит в службу Azure ATP только проанализированные данные, а не все журналы.

## <a name="azure-atp-components"></a>Компоненты Azure ATP
Azure ATP включает в себя следующие компоненты.

-   **Портал управления рабочей областью Azure ATP** <br>
На портале управления рабочей областью Azure ATP можно создавать рабочие области и включать интеграцию с другими службами Майкрософт.

> [!NOTE]
> К одной рабочей области могут подключаться только датчики из одного леса Active Directory.

-   **Портал рабочей области Azure ATP** <br>
Портал рабочей области Azure ATP получает данные с датчиков и автономных датчиков ATP. Он отслеживает, изучает угрозы в вашей среде и управляет ими.

-   **Датчик Azure ATP**<br>
Датчик Azure ATP устанавливается непосредственно на контроллерах домена и напрямую отслеживает их трафик. Для этого не нужен выделенный сервер и не требуется настраивать зеркальное отображение портов. 

-   **Автономный датчик Azure ATP**<br>
Автономный датчик Azure ATP устанавливается на выделенном сервере, отслеживающем трафик от контроллеров домена, посредством зеркального отображения портов или перехватчика трафика. Он представляет собой альтернативу датчику Azure ATP.

## <a name="deployment-options"></a>Варианты развертывания
При развертывании Azure ATP можно использовать следующие сочетания датчиков:

-   **Использование только датчиков Azure ATP**<br>
В развертывании Azure ATP могут быть только датчики Azure ATP: они развертываются на каждом контроллере домена. При этом не нужно настраивать дополнительные серверы или зеркальное отображение портов.

-   **Использование только автономных датчиков Azure ATP** <br>
В развертывании Azure ATP могут быть только автономные датчики Azure ATP (без датчиков Azure ATP): все контроллеры домена должны быть настроены для включения зеркального отображения портов на автономном датчике Azure ATP либо должны присутствовать сетевые перехватчики трафика.

-   **Использование автономных датчиков Azure ATP и датчиков Azure ATP**<br>
В развертывание Azure ATP входят и автономные датчики Azure ATP, и датчики Azure ATP. Датчики Azure ATP устанавливаются на некоторых контроллерах домена (например, на всех контроллерах домена на сайтах филиалов). В то же время трафик других контроллеров домена (например, контроллеров домена большого размера в основных центрах обработки данных) отслеживают автономные датчики Azure ATP.


### <a name="azure-atp-workspace-management-portal"></a>Портал управления рабочей областью Azure ATP

Портал управления рабочей областью Azure ATP позволяет выполнять следующие задачи:

-   создавать рабочие области Azure ATP и управлять ими;

-   выполнять интеграцию с другими службами безопасности Майкрософт.

Главную рабочую область можно задать как **основную**. Настройка рабочей области в качестве основной оказывает влияние на интегрируемые компоненты — для основной рабочей области можно интегрировать только Azure ATP с ATP в Защитнике Windows. 

> [!NOTE]
> - Сейчас в Azure ATP поддерживается создание лишь одной рабочей области. После удаления рабочей области вы можете активировать ее повторно, обратившись в службу поддержки. Вы можете удалить не более трех рабочих областей. Чтобы сохранить больше удаленных рабочих областей, обратитесь в службу поддержки Azure ATP.
> - Если в вашей рабочей области в течение 60 дней не будет установлен датчик, она может быть удалена и вам потребуется создать ее заново.



### <a name="azure-atp-workspace-portal"></a>Портал рабочей области Azure ATP

На портале рабочей области Azure ATP можно управлять следующими функциональными возможностями Azure ATP:

-   управлять параметрами конфигурации датчика и автономного датчика Azure ATP;

-   просматривать данные, полученные с автономных датчиков Azure ATP и датчиков Azure ATP; 

-   отслеживать обнаруженные подозрительные действия на основе поведенческих алгоритмов машинного обучения в целях выявления необычного поведения и на основе детерминированных алгоритмов для выявления новейших атак в цепочке атак.

-   Необязательно: портал управления рабочей областью можно настроить для отправки сообщений электронной почты и событий при обнаружении подозрительных действий или событий работоспособности.


|||
|-|-|
|Получатель сущностей|Получает пакеты сущностей со всех датчиков Azure ATP и автономных датчиков Azure ATP.|
|Обработчик сетевых операций|Этот компонент обрабатывает все сетевые операции в каждом полученном пакете. К примеру, он сопоставляет различные действия Kerberos, выполненные на разных компьютерах.|
|Профилировщик сущностей|Этот компонент профилирует все уникальные сущности в соответствии с трафиком и событиями. Например, Azure ATP обновляет список компьютеров, с которых выполнен вход, для каждого профиля пользователя.|
|Портал управления рабочей областью Azure ATP|Управляет рабочими областями Azure ATP.|
|Портал рабочей области Azure ATP|Рабочая область Azure ATP используется для настройки Azure ATP и отслеживания подозрительных действий, обнаруженных Azure ATP в сети. Рабочая область Azure ATP не зависит от датчика Azure ATP и выполняется даже в том случае, когда служба датчик Azure ATP остановлена. |
|Средства обнаружения|Эти компоненты выявляют подозрительные действия и аномальное поведение пользователей в сети, используя алгоритмы машинного обучения и детерминированные правила.|

При определении числа рабочих областей Azure ATP, которые необходимо развернуть в сети, учитывайте указанные ниже критерии.

-   Одна рабочая область Azure ATP может отслеживать лишь один лес Active Directory. При наличии нескольких лесов Active Directory для каждого из них требуется по крайней мере одна облачная служба Azure ATP.


## <a name="azure-atp-sensor-and-azure-atp-standalone-sensor"></a>Датчик Azure ATP и автономный датчик Azure ATP

**Датчик Azure ATP** и **автономный датчик Azure ATP** имеют одинаковые основные функции:

-   фиксация и проверка сетевого трафика контроллеров домена (трафик на зеркально отображенных портах для автономных датчиков Azure ATP и локальный трафик контроллера домена для датчиков Azure ATP); 

-   получение событий Windows либо непосредственно из контроллеров домена (для датчиков ATP), либо с сервера SIEM или сервера системного журнала (для автономных датчиков ATP);

-  получение сведений об учете RADIUS от поставщика VPN;

-   получение данных о пользователях и компьютерах из домена Active Directory;

-   разрешение сетевых сущностей (пользователей, групп и компьютеров);

-   передача соответствующих данных в облачную службу Azure ATP;

-   мониторинг нескольких контроллеров домена из одного автономного датчика Azure ATP или одного контроллера домена для датчика Azure ATP.

По умолчанию Azure ATP поддерживает до 100 датчиков. Чтобы установить дополнительные датчики, обратитесь в службу поддержки Azure ATP.

Автономный датчик Azure ATP получает сетевой трафик и события Windows из сети и обрабатывает их с помощью следующих основных компонентов:

|||
|-|-|
|Прослушиватель сети|Этот компонент фиксирует и анализирует сетевой трафик. Эта задача существенно нагружает ЦП, поэтому при настройке датчика Azure ATP или автономного датчика Azure ATP необходимо выполнить [предварительные требования к Azure ATP](atp-prerequisites.md).|
|Прослушиватель событий|Этот компонент фиксирует и анализирует события Windows, пересылаемые с сервера SIEM в сети.|
|Средство чтения журнала событий Windows|Этот компонент считывает и анализирует события Windows, пересылаемые в журнал событий Windows автономного датчика Azure ATP с контроллеров домена.|
|Транслятор сетевых операций | Этот компонент преобразует проанализированный трафик (сетевые операции) в логическое представление трафика Azure ATP.
|Сопоставитель сущностей|Этот компонент принимает проанализированные данные (сетевой трафик и события) и разрешает их с помощью Active Directory, чтобы найти сведения об учетных записях и удостоверениях. Затем они сопоставляются с IP-адресами в этих данных. Сопоставитель сущностей проверяет заголовки пакетов и анализирует пакеты аутентификации для определения имен, свойств и удостоверений компьютеров. Затем он объединяет проанализированные пакеты аутентификации с данными в пакете.|
|Отправитель сущностей|Этот компонент отправляет проанализированные и сопоставленные данные в облачную службу Azure ATP.|

## <a name="azure-atp-sensor-features"></a>Функции датчика Azure ATP

Следующие компоненты и возможности работают по-разному в автономном датчике Azure ATP и датчике Azure ATP.

-   Датчик Azure ATP может считывать события локально — настраивать переадресацию событий не требуется.

-   **Потенциальный синхронизатор домена**<br>
Потенциальный синхронизатор домена отвечает за своевременную синхронизацию всех сущностей из определенного домена Active Directory (аналогичный механизм используется для репликации в контроллерах домена). В списке синхронизаторов домена случайным образом выбирается один датчик. <br><br>
Если синхронизатор находится в автономном режиме более 30 минут, его заменяет другой кандидат. Если для конкретного домена синхронизатор домена недоступен, Azure ATP может своевременно синхронизировать сущности и изменения в них. Однако Azure ATP будет оперативно получать новые сущности по мере их обнаружения в отслеживаемом трафике. 
<br>Если синхронизатор домена недоступен и требуется сущность, с которой не связан трафик, результаты поиска будут пусты.<br><br>
По умолчанию в качестве потенциальных синхронизаторов указываются все автономные датчики Azure ATP.<br><br>
Датчики Azure ATP не являются потенциальными синхронизаторами по умолчанию.


-   **Ограничения ресурсов**<br>
Датчик Azure ATP содержит компонент мониторинга, который оценивает доступный объем вычислительных ресурсов и памяти на контроллере домена, в котором он выполняется. Мониторинг выполняется каждые 10 секунд. При этом также осуществляется динамическое обновление квоты использования ресурсов ЦП и памяти для датчика Azure ATP. Благодаря этому в любой момент времени на контроллере домена доступно по крайней мере 15 % свободных вычислительных ресурсов и ресурсов памяти.<br><br>
Независимо от операций, выполняемых на контроллере домена, в результате всегда освобождаются ресурсы, чтобы обеспечить непрерывную работу основных функций контроллера домена.<br><br>
Если это приводит к нехватке ресурсов датчика Azure ATP, отслеживается только часть трафика, а на странице работоспособности появится оповещение мониторинга Dropped port mirrored network traffic (Сетевой трафик зеркально отображенных портов сброшен).

В таблице ниже приведен пример контроллера домена с достаточным количеством вычислительных ресурсов для больших квот, чем нужны в данный момент, чтобы обеспечить мониторинг всего трафика:

> [!div class="mx-tableFixed"]
||||||
|-|-|-|-|-|
|Active Directory (Lsass.exe)|Датчик Azure ATP (Microsoft.Tri.sensor.exe)|Разное (другие процессы) |Квота датчика Azure ATP|Датчик отклоняет трафик?|
|30 %|20 %|10 %|45 %|Нет|

Если Active Directory требуются дополнительные вычислительные ресурсы, квота для датчика Azure ATP сокращается. В следующем примере датчику Azure ATP требуется больше ресурсов, чем выделено квотой. Поэтому он сбрасывает некоторый трафик (выполняется мониторинг только части трафика):

> [!div class="mx-tableFixed"]
||||||
|-|-|-|-|-|
|Active Directory (Lsass.exe)|Датчик Azure ATP (Microsoft.Tri.sensor.exe)|Разное (другие процессы) |Квота датчика Azure ATP|Датчик отклоняет трафик?|
|60 %|15 %|10 %|15 %|Да|


## <a name="your-network-components"></a>Компоненты сети
Для работы с Azure ATP убедитесь, что настроены следующие компоненты.

### <a name="port-mirroring"></a>Зеркальное отображение портов
При использовании автономных датчиков Azure ATP необходимо настроить зеркальное отображение портов для контроллеров домена, которые будут отслеживаться, и указать автономный датчик Azure ATP в качестве места назначения с помощью физических или виртуальных коммутаторов. Кроме того, можно использовать перехватчик трафика. Azure ATP будет работать, если мониторинг выполняется только для некоторых контроллеров домена, однако эффективность обнаружения будет ниже.

Хотя при зеркальном отображении портов автономный датчик Azure ATP получает весь зеркально отображенный сетевой трафик контроллера домена, для анализа в облачную службу Azure ATP отправляется лишь небольшой объем данных о трафике в сжатом виде.

Контроллеры домена и автономные датчики Azure ATP могут быть физическими или виртуальными. Дополнительные сведения см. в статье [Настройка зеркального отображения портов](configure-port-mirroring.md).


### <a name="events"></a>Элемент Event
Для повышения эффективности обнаружения атак Pass-the-Hash, атак методом подбора, изменений привилегированных групп, создания подозрительных служб, изменения Honeytoken Azure ATP требуются следующие события Windows: 4776, 4732, 4733, 4728, 4729, 4756, 4757 и 7045. Они могут автоматически считываться датчиком Azure ATP или, если датчик Azure ATP не развернут, передаваться в автономный датчик Azure ATP путем настройки прослушивания событий SIEM в автономном датчике Azure ATP или [настройки пересылки событий Windows](configure-event-forwarding.md).

-   Настройка прослушивания событий SIEM в автономном датчике Azure ATP <br>Настройте пересылку определенных событий Windows из системы SIEM в ATP. Azure ATP поддерживает несколько поставщиков SIEM. Дополнительные сведения см. в статье [Настройка пересылки событий](configure-event-forwarding.md).

-   Настройка пересылки событий Windows<br>Чтобы обеспечить отправку сведений о событиях в Azure ATP, можно также настроить пересылку событий Windows 4776, 4732, 4733, 4728, 4729, 4756, 4757 и 7045 с контроллеров домена в автономный датчик Azure ATP. Это целесообразно, если у вас нет SIEM или ваша версия SIEM в настоящее время не поддерживается в ATP. Дополнительные сведения о пересылке событий Windows в ATP см. в статье [Настройка пересылки событий Windows](configure-event-forwarding.md). Это относится только к физическим автономным датчикам Azure ATP, а не к датчикам Azure ATP.


## <a name="see-also"></a>См. также
- [Предварительные требования к Azure ATP](atp-prerequisites.md)
- [Средство изменения размера Azure ATP](http://aka.ms/trisizingtool)
- [Планирование производительности Azure ATP](atp-capacity-planning.md)
- [Настройка пересылки событий](configure-event-forwarding.md)
- [Настройка пересылки событий Windows](configure-event-forwarding.md)

- - [Обязательно ознакомьтесь с форумом ATP](https://aka.ms/azureatpcommunity)
