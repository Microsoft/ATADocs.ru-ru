---
title: Установка Azure Advanced Threat Protection | Документы Майкрософт
description: На этом этапе установки ATP настраиваются источники данных.
keywords: ''
author: shsagir
ms.author: shsagir
manager: rkarlin
ms.date: 09/23/2019
ms.topic: conceptual
ms.collection: M365-security-compliance
ms.service: azure-advanced-threat-protection
ms.assetid: 88692d1a-45a3-4d54-a549-4b5bba6c037b
ms.reviewer: itargoet
ms.suite: ems
ms.openlocfilehash: a4150ce673ce73142139d7c85935e711a64e5046
ms.sourcegitcommit: 9673eb49729a06d3a25d52c0f43c76ac61b9cf89
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2020
ms.locfileid: "75907039"
---
# <a name="configure-event-collection"></a>Настройка сбора данных о событиях

Чтобы оптимизировать возможности обнаружения вторжений, Azure ATP требуется доступ к следующим событиям Windows: 4776, 4732, 4733, 4728, 4729, 4756, 4757, 7045 и 8004. Эти события может автоматически считывать датчик Azure ATP. Если датчик Azure ATP не развернут, они передаются в автономный датчик Azure ATP. Для этого в автономном датчике Azure ATP настраивается ожидание передачи событий SIEM или [пересылка событий Windows](configure-event-forwarding.md).

> [!NOTE]
> Очень важно выполнить скрипт аудита Azure ATP перед настройкой сбора данных о событиях, чтобы обеспечить правильность настройки контроллеров домена для записи необходимых событий. 

Помимо сбора и анализа входящего и исходящего сетевого трафика с контроллеров домена, Azure ATP может использовать события Windows для улучшенного обнаружения. Azure ATP использует события Windows 4776 и 8004 для NTLM, чтобы улучшить обнаружение различных атак, а события 4732, 4733, 4728, 4729, 4756, 4757, 7045 и 8004 позволяют улучшить обнаружение изменения привилегированных групп и создание службы. Эти события можно получать из системы SIEM или путем настройки пересылки событий Windows с контроллера домена. Собранные события предоставляют Azure ATP дополнительные данные, которые невозможно получить через сетевой трафик контроллера домена.

## <a name="ntlm-authentication-using-windows-event-8004"></a>Аутентификация NTLM с использованием события Windows 8004

Чтобы настроить сбор событий Windows 8004, выполните следующие действия:
1. Перейдите к расположению "Конфигурация компьютера" \ "Параметры Windows" \ "Параметры безопасности" \ "Локальные политики" \ "Параметры безопасности".
2. Настройте **групповую политику домена** следующим образом:
   - Сетевая безопасность: Ограничение NTLM: Исходящий трафик NTLM к удаленным серверам = **Аудит всего**
   - Сетевая безопасность: Ограничение NTLM: Аудит аутентификации NTLM в этом домене = **Включить все**
   - Сетевая безопасность: Ограничение NTLM: Аудит входящего трафика NTLM = **Включить аудит для всех учетных записей**

Когда датчик Azure ATP анализирует событие Windows 8004, действия аутентификации NTLM Azure ATP обогащаются данными, к которым получает доступ сервер.

## <a name="siemsyslog"></a>Система SIEM/системный журнал
Для обработки Azure ATP данных с сервера системного журнала необходимо выполнить следующие шаги:

- Настройте серверы датчика Azure ATP на прослушивание и прием событий, перенаправляемых с сервера SIEM или системного журнала.

  > [!NOTE]
  > Azure ATP прослушивает только IPv4, но не IPv6. 

- Настройте сервер SIEM или сервер системного журнала на пересылку определенных событий на датчик Azure ATP.

> [!IMPORTANT]
> -   Не пересылайте все данные системного журнала на датчик Azure ATP.
> -   Azure ATP поддерживает трафик UDP с сервера SIEM или сервера системного журнала.

Подробности о настройке пересылки событий на другой сервер см. в документации по серверу SIEM или системному журналу. 

> [!NOTE]
>Если сервер SIEM или сервер системного журнала отсутствует, настройку контроллеров домена Windows можно выполнить таким образом, чтобы решение Azure ATP выполняло сбор и анализ всех необходимых событий.

## <a name="configuring-the-azure-atp-sensor-to-listen-for-siem-events"></a>Настройка прослушивания событий SIEM в датчике Azure ATP

1.  В разделе настройки Azure ATP на вкладке **Источники данных** щелкните **SIEM**, включите **Системный журнал** и нажмите кнопку **Сохранить**.

    ![Разрешите использование образа UDP для прослушивания системного журнала](media/atp-siem-config.png)

2.  Выполните настройку сервера SIEM или сервера системного журнала таким образом, чтобы все необходимые события направлялись на IP-адрес одного из датчиков Azure ATP. Дополнительные сведения о настройке SIEM см. в справке в Интернете. Сведения об особых требованиях к форматированию каждого сервера SIEM см. в вариантах технической поддержки.

Azure ATP поддерживает события SIEM в следующих форматах:  

## <a name="rsa-security-analytics"></a>Аналитика безопасности RSA
&lt;Заголовок системного журнала&gt;RsaSA\n2015-May-19 09:07:09\n4776\nMicrosoft-Windows-Security-Auditing\nSecurity\XXXXX.subDomain.domain.org.il\nYYYYY$\nMMMMM \n0x0

-   Заголовок системного журнала необязателен.

-   Между всеми полями должен стоять символ-разделитель "\n".

-   Поля в порядке очередности:

    1.  Постоянное значение RsaSA (должно появиться).

    2.  Метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки в ATP). Важно! Значение желательно представлять в миллисекундах.

    3.  код события Windows.

    4.  Имя поставщика событий Windows

    5.  Имя журнала событий Windows

    6.  Имя компьютера, получающего событие (в данном случае контроллера домена)

    7.  Имя пользователя, подлинность которого проверяется

    8.  Имя исходного узла

    9. Код результата NTLM

-   Поскольку порядок важен, в сообщении не должно быть ничего другого.

## <a name="hp-arcsight"></a>HP Arcsight
CEF:0|Microsoft|Microsoft Windows||Microsoft-Windows-Security-Auditing:4776|Контроллер домена попытался проверить учетные данные для учетной записи.|Low| externalId=4776 cat=Security rt=1426218619000 shost=KKKKKK dhost=YYYYYY.subDomain.domain.com duser=XXXXXX cs2=Security cs3=Microsoft-Windows-Security-Auditing cs4=0x0 cs3Label=EventSource cs4Label=Reason or Error Code

-   Должно соответствовать определению протокола.

-   Отсутствует заголовок системного журнала.

-   Заголовок определения (часть, разделенная вертикальной линией) должен существовать (как указано в протоколе).

-   В _расширении_ должны присутствовать следующие ключи:

    -   externalId = код события Windows

    -   rt = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки в ATP). Важно! Значение желательно представлять в миллисекундах.

    -   cat = имя журнала событий Windows

    -   shost = имя исходного узла

    -   dhost = имя компьютера, получающего событие (в данном случае контроллера домена)

    -   duser = имя пользователя, подлинность которого проверяется

-   Для _расширения_ порядок представления неважен

-   Для следующих двух полей следует назначить отдельный ключ и метку ключа:

    -   "EventSource"

    -   "Reason or Error Code" = код результата NTLM

## <a name="splunk"></a>Splunk
&lt;Заголовок системного журнала&gt;\r\nEventCode=4776\r\nLogfile=Security\r\nSourceName=Microsoft-Windows-Security-Auditing\r\nTimeGenerated=20150310132717.784882-000\r\ComputerName=YYYYY\r\nMessage=

Компьютер попытался проверить учетные данные для учетной записи.

Пакет проверки подлинности:              MICROSOFT_AUTHENTICATION_PACKAGE_V1_0

Учетная запись входа: Администратор

Исходная рабочая станция:       SIEM

Код ошибки:         0x0

-   Заголовок системного журнала необязателен.

-   Между всеми обязательными полями стоит символ-разделитель "\r\n".

-   Поля имеют формат ключ = значение.

-   Наличие следующих ключей и их значений обязательно:

    -   EventCode = код события Windows

    -   Logfile = имя журнала событий Windows

    -   SourceName = имя поставщика событий Windows

    -   TimeGenerated = метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки в ATP). Важно! Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

    -   ComputerName = имя исходного узла

    -   Message = исходный текст события Windows

-   Ключ сообщения и его значение должны быть в конце.

-   Для пар ключ=значение порядок представления неважен.

## <a name="qradar"></a>QRadar
QRadar активирует сбор данных о событиях через агента. Если сбор данных происходит с помощью агента, то формат времени представляется без указания миллисекунд. Так как Azure ATP требуются данные о миллисекундах, необходимо настроить в QRadar сбор данных о событиях Windows без агента. Дополнительные сведения см. в разделе [http://www-01.ibm.com/support/docview.wss?uid=swg21700170](http://www-01.ibm.com/support/docview.wss?uid=swg21700170 "QRadar: безагентный сбор данных о событиях Windows с помощью протокола MSRPC").

    <13>Feb 11 00:00:00 %IPADDRESS% AgentDevice=WindowsLog AgentLogFile=Security Source=Microsoft-Windows-Security-Auditing Computer=%FQDN% User= Domain= EventID=4776 EventIDCode=4776 EventType=8 EventCategory=14336 RecordNumber=1961417 TimeGenerated=1456144380009 TimeWritten=1456144380009 Message=The computer attempted to validate the credentials for an account. Authentication Package: MICROSOFT_AUTHENTICATION_PACKAGE_V1_0 Logon Account: Administrator Source Workstation: HOSTNAME Error Code: 0x0

Необходимо задать следующие сведения в полях:

- тип агента для сбора данных;
- имя поставщика журнала событий Windows;
- источник журнала событий Windows;
- полное доменное имя контроллера домена;
- код события Windows.

TimeGenerated — это метка времени фактического события (необходимо убедиться в том, что это значение не является меткой времени поступления на SIEM или отправки в ATP). Важно! Значение должно быть представлено в формате yyyyMMddHHmmss.FFFFFF, желательно в миллисекундах.

Message — это исходный текст события Windows.

Между парами "ключ-значение" должен быть разделитель \t.

>[!NOTE] 
> Использование WinCollect для сбора данных о событиях Windows не поддерживается.




## <a name="see-also"></a>См. также
- [Средство изменения размера Azure ATP](https://aka.ms/aatpsizingtool)
- [Справочник по журналу Azure ATP SIEM](cef-format-sa.md)
- [Предварительные требования к Azure ATP](atp-prerequisites.md)
- [Загляните на форум Azure ATP!](https://aka.ms/azureatpcommunity)
