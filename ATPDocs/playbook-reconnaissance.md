---
title: Руководство. Сборник схем рекогносцировки в Azure ATP
description: В сборнике схем рекогносцировки в Azure ATP показано, как смоделировать угрозы рекогносцировки для их обнаружения с помощью Azure ATP.
ms.service: azure-advanced-threat-protection
ms.topic: how-to
author: shsagir
ms.author: shsagir
ms.date: 09/01/2019
ms.reviewer: itargoet
ms.openlocfilehash: 235894040ff84fe627b4cbe4d4ecd857a7555e76
ms.sourcegitcommit: c7c0a4c9f7507f3e8e0f219798ed7d347c03e792
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/22/2020
ms.locfileid: "90912649"
---
# <a name="tutorial-reconnaissance-playbook"></a>Руководство. Сборник схем рекогносцировки

[!INCLUDE [Rebranding notice](includes/rebranding.md)]

В этой серии руководств из четырех частей, посвященной оповещениям системы безопасности Azure ATP, во втором руководстве приведен сборник схем рекогносцировки. Лаборатория для оповещений системы безопасности **Azure ATP** позволяет продемонстрировать возможности Azure ATP по определению и обнаружению подозрительных действий и потенциальных атак в сети. В сборнике схем показано, как проверить некоторые из обнаруженных *дискретных* действий в Azure ATP. Основное внимание уделяется возможностям Azure ATP, основанным на использовании *подписей*. В этом сборнике схем не описаны оповещения или обнаружения, основанные на расширенных возможностях машинного обучения или на поведении пользователя или сущности, так как для их применения изучаемый период с реальным сетевым трафиком должен составлять до 30 дней. Дополнительные сведения по каждому руководству из этой серии о лаборатории для оповещений системы безопасности ATP см. в [этой статье](playbook-lab-overview.md).

В этом сборнике описаны службы обнаружения угроз и оповещения системы безопасности Azure ATP для имитации атак с использованием общих, реальных и общедоступных средств взлома и атак.

В этом руководстве описаны следующие задачи:
> [!div class="checklist"]
> * Моделирование рекогносцировки путем сетевого сопоставления.
> * Моделирование рекогносцировки с использованием службы каталогов.
> * Моделирование рекогносцировки с применением данных пользователя и IP-адреса (SMB).
> * Просмотр оповещений системы безопасности в результате моделирования рекогносцировки в Azure ATP.

## <a name="prerequisites"></a>Предварительные условия

[Настроенная лаборатория оповещений системы безопасности в ATP](playbook-setup-lab.md).
  - Рекомендуем как можно точнее следовать инструкции при настройке лаборатории. Чем точнее параметры настроенной лаборатории совпадают с указанными в инструкции, тем проще будет выполнить процедуры тестирования Azure ATP.

## <a name="simulate-a-reconnaissance-attack"></a>Моделирование атаки рекогносцировки

Как только злоумышленник получает доступ к вашей среде, начинается кампания рекогносцировки. На этом этапе злоумышленник обычно тратит много времени на изучение. Злоумышленники пытаются обнаружить интересующие компьютеры, выполнить перечисление пользователей и групп, собрать важные IP-адреса и получить представление о ресурсах и уязвимостях организации. Действия рекогносцировки позволяют злоумышленникам получить полное понимание и представление вашей среды, чтобы использовать эту информацию в дальнейшем.

Методы тестирования атаки рекогносцировки:

* рекогносцировка путем сетевого сопоставления;
* рекогносцировка с использованием службы каталогов;
* рекогносцировка с применением данных пользователя и IP-адреса (SMB).

## <a name="network-mapping-reconnaissance-dns"></a>Разведывательная атака путем сетевого сопоставления (DNS)

В первую очередь злоумышленник попытается получить копию всей информации службы DNS. Если злоумышленнику это удалось, он получает дополнительную информацию о вашей среде, которая может включать аналогичную информацию о других ваших средах или сетях.

До завершения восьмидневного периода обучения Azure ATP подавляет действия рекогносцировки сетевого сопоставления, представленные на **временной шкале подозрительных действий**. В период обучения Azure ATP узнает, какие из действий в сети являются обычными, а какие аномальными. По истечении восьмидневного периода обучения при возникновении аномальных событий рекогносцировки сетевого сопоставления активируется соответствующее оповещение системы безопасности. 

### <a name="run-nslookup-from-victimpc"></a>Запуск nslookup из VictimPC

Для проверки рекогносцировки DNS мы используем встроенную программу командной строки (*nslookup*), чтобы инициировать передачу зоны DNS. DNS-серверы с правильной конфигурацией отклонят запросы такого типа и запретят попытки передачи зоны.  

Войдите в учетную запись **VictimPC** с использованием скомпрометированных учетных данных JeffL. Выполните следующую команду:

``` cmd
nslookup
```

Введите **server** и полное доменное имя или IP-адрес контроллера домена, на котором установлен датчик ATP.

```nslookup
server contosodc.contoso.azure
```

Попробуем перенести данные домена.

```nslookup
ls -d contoso.azure
```

- Замените contosodc.contoso.azure и contoso.azure на полное доменное имя и доменное имя вашего датчика Azure ATP соответственно.

 ![Неудачная попытка команды nslookup скопировать данные DNS-сервера](media/playbook-recon-nslookup.png)

Если **ContsoDC** — это первый развернутый датчик, подождите 15 минут, пока внутренняя служба базы данных завершит развертывание необходимых микрослужб.

### <a name="network-mapping-reconnaissance-dns-detected-in-azure-atp"></a>В Azure ATP обнаружена рекогносцировка путем сетевого сопоставления (DNS)

Чтобы обеспечить защиту от угроз в домене, важно обеспечить видимость для этого типа атаки (успешной или неудачной). После установки среды перейдите к временной шкале **логических действий**, чтобы просмотреть обнаруженные действия. 

В строке поиска Azure ATP введите **VictimPC**, а затем щелкните найденную запись, чтобы просмотреть временную шкалу.

![С помощью AATP была обнаружена рекогносцировка DNS, представление высокого уровня](media/playbook-recon-nslookupdetection1.png)

Найдите действие "AXFR query" (Запрос AXFR). Azure ATP обнаруживает этот тип рекогносцировки DNS. 
  - Если отображается большое количество действий, щелкните **Фильтровать по** и отмените выбор всех типов, кроме **Запрос DNS**.

![Подробное представление обнаружения рекогносцировки DNS в AATP](media/playbook-recon-nslookupdetection2.png)

Если ваш аналитик безопасности определил, что это действие выполнено с помощью средства проверки безопасности, можно отключить оповещения об обнаружении для отдельного устройства. В правой верхней части оповещения щелкните многоточие. Затем щелкните **Close and exclude MySecurityScanner** (Закрыть и исключить MySecurityScanner). Это оповещение больше не будет отображаться при повторном обнаружении действия из средства проверки MySecurityScanner.

Обнаружив сбой, вы получаете полезные сведения так же, как и при обнаружении атаки в среде. На портале Azure ATP можно увидеть точный результат действий возможного злоумышленника. В смоделированном сценарии рекогносцировки DNS мы были остановлены под видом злоумышленников при попытке резервного копирования записей DNS домена. Из оповещения безопасности Azure ATP ваша команда специалистов по безопасности узнала о попытке атаки и компьютере, который использовался для этого.

## <a name="directory-service-reconnaissance"></a>Рекогносцировка с использованием службы каталогов

Следующая цель для злоумышленника в рамках рекогносцировки — перечислить всех пользователей и группы в лесу. До завершения 30-дневного периода обучения Azure ATP подавляет попытки перечисления в службе каталогов, представленные на временной шкале подозрительных действий. В период обучения Azure ATP узнает, какие из действий в сети являются обычными, а какие аномальными. По завершении 30-дневного периода обучения аномальные события перечисления в службе каталогов вызывают оповещение системы безопасности. В течение 30-дневного периода обучения вы можете увидеть обнаружения этих действий в Azure ATP с использованием временной шкалы активности объекта в сети. В этой лаборатории показаны обнаружения таких действий в Azure ATP.

Чтобы продемонстрировать общий метод рекогносцировки службы каталогов, мы используем собственный двоичный файл Майкрософт *net*. После выполненной попытки, изучив временную шкалу активности JeffL, Azure ATP обнаруживает это действие нашего скомпрометированного пользователя.

### <a name="directory-service-enumeration-via-net-from-victimpc"></a>Перечисление службы каталогов с помощью *net* из VictimPC

Любой пользователь или компьютер, прошедший проверку подлинности, может потенциально перечислять других пользователей и группы в домене. Эта возможность перечисления требуется для правильной работы большинства приложений. Наш скомпрометированный пользователь JeffL — это непривилегированная учетная запись домена. В этой смоделированной атаке мы увидим, как даже непривилегированная учетная запись домена может по-прежнему предоставлять злоумышленнику ценные данные.

1. Выполните следующую команду из **VictimPC**:

    ``` cmd
    net user /domain
    ```

   В окне выходных данных отображаются все пользователи в домене Contoso.Azure.

    ![Перечисление всех пользователей в домене](media/playbook-recon-dsenumeration-netusers.png)

1. Попробуем получить перечень всех групп в домене. Выполните следующую команду:

    ``` cmd
    net group /domain
    ```

   В окне выходных данных отображаются все группы в домене Contoso.Azure. Обратите внимание, что одна из групп безопасности в списке не задана по умолчанию: **Helpdesk**.

    ![Перечисление всех групп в домене](media/playbook-recon-dsenumeration-netgroups.png)

1. Теперь давайте перечислим только группу "Администраторы домена". Выполните следующую команду:

    ``` cmd
    net group "Domain Admins" /domain
    ```

    ![Перечисление всех членов группы "Администраторы домена"](media/playbook-recon-dsenumeration-netdomainadmins.png)

    Выступая в качестве злоумышленника, мы узнали, что в группе "Администраторы домена" есть два члена: **SamiraA** и **ContosoAdmin** (администратор контроллера домена, заданный по умолчанию). Узнав, что между доменом и лесом нет границ безопасности, попытаемся перечислить администраторов предприятия.

1. Чтобы попытаться перечислить администраторов предприятия, выполните следующую команду:

    ``` cmd
   net group "Enterprise Admins" /domain
   ```

   Мы узнали, что есть только один администратор предприятия — ContosoAdmin. Это не очень важно, так как мы уже знаем, что между нашим доменом и лесом нет границ безопасности.

    ![Администраторы предприятия, перечисленные в домене](media/playbook-recon-dsenumeration-netenterpriseadmins.png)

Благодаря информации, полученной в ходе рекогносцировки, мы теперь знаем о группе безопасности Helpdesk. Хоть эта информация *пока что* не представляет особого интереса. Нам также известно, что **SamiraA** является членом группы администраторов домена. Если получить учетные данные пользователя SamiraA, мы сможем получить доступ к самому контроллеру домена.

### <a name="directory-service-enumeration-detected-in-azure-atp"></a>Перечисление служб каталогов, обнаруженное в Azure ATP

Если бы в лаборатории использовалась *реальная активность за 30 дней с установленной службой Azure ATP*, действия, которые мы выполнили от имени пользователя JeffL, скорее всего классифицировались бы как аномальные. Аномальные действия отображаются на временной шкале подозрительных действий. Так как мы только что установили среду, перейдите к временной шкале логических действий.

Давайте используем поиск Azure ATP и посмотрим, как выглядит временная шкала логических действий JeffL:

![Найдите временную шкалу логических действий для конкретной сущности](media/playbook-recon-dsenumeration-searchlogicalactivity.png)

Мы можем увидеть, когда пользователь JeffL вошел в VictimPC с использованием протокола Kerberos. Кроме того мы видим, что пользователь JeffL из VictimPC получил перечень всех пользователей в домене.

![Временная шкала логических действий пользователя JeffL](media/playbook-recon-dsenumeration-jeffvlogicalactivity.png)

Многие действия регистрируются на временной шкале логических действий, давая возможность проводить цифровые расследования и реагировать на инциденты (DFIR). Вы можете также просматривать действия, изначально обнаруженные не с помощью Azure ATP, а посредством ATP в Microsoft Defender, Microsoft 365 и других продуктов.

Рассмотрим страницу **ContosoDC**, на которой также отображаются компьютеры, в систему которых вошел пользователь JeffL.

![Компьютеры, в систему которых вошел пользователь JeffL](media/playbook-recon-dsenumeration-jeffvloggedin.png)

Мы также можем получить данные каталога из в Azure ATP, включая членство и параметры контроля доступа JeffL.

![Данные каталога JeffL в AATP](media/playbook-recon-dsenumeration-jeffvdirectorydata.png)

Теперь обратите внимание на перечисления сеансов SMB.

## <a name="user-and-ip-address-reconnaissance-smb"></a>Рекогносцировка с применением данных пользователя и IP-адреса (SMB)

Папка sysvol в Active Directory — это одна из наиболее важных, *если не самая* важная сетевая папка в среде. Чтобы извлекать групповые политики, каждый компьютер и пользователь должны иметь доступ к этой конкретной сетевой папке. Злоумышленник может получить много информации, узнав, кто из пользователей имеет активные сеансы с использованием папки sysvol.

Затем выполним перечисление сеансов SMB для ресурса ContosoDC. Мы хотим узнать, кто еще имеет сеансы с общей папкой SMB, и *с каких IP-адресов*.

### <a name="use-joewares-netsessexe-from-victimpc"></a>Использование файла NetSess.exe JoeWare из VictimPC

Запустите средство **NetSess** JoeWare для ContosoDC в контексте пользователя, прошедшего проверку подлинности. В нашем случае это ContosoDC.

``` cmd
NetSess.exe ContosoDC
```

![Злоумышленники используют рекогносцировку SMB, чтобы идентифицировать пользователей и их IP-адреса](media/playbook-recon-smbrecon.png)

Теперь нам известно, что SamiraA — это администратор домена. С помощью этой атаки удалось определить IP-адрес SamiraA — 10.0.24.6. Как злоумышленник, мы точно узнали, чей компьютер нам нужно скомпрометировать. Мы также получили расположение в сети, где эти учетные данные использовались для входа.

### <a name="user-and-ip-address-reconnaissance-smb-detected-in-azure-atp"></a>В Azure ATP обнаружена рекогносцировка с применением данных пользователя и IP-адреса

Теперь можно увидеть, какие угрозы были обнаружены с помощью Azure ATP.

![Обнаружение рекогносцировки SMB с помощью AATP](media/playbook-recon-smbrecon-detection1.png)

Мы узнали не только об этом действии, но и об открытых учетных записях и их IP-адресах *в этот момент времени*. Как Центр операций безопасности (SOC), мы получили не только данные о попытке и ее состоянии, но и ответ, отправленный злоумышленнику. Эта информация будет полезной в нашем исследовании.


## <a name="next-steps"></a>Дальнейшие шаги

Следующим этапом в модели атаки kill chain обычно является попытка бокового смещения.

> [!div class="nextstepaction"]
> [Сборник схем бокового смещения в Azure ATP](playbook-lateral-movement.md)

## <a name="join-the-community"></a>Присоединяйтесь к сообществу!

Возникли дополнительные вопросы или желание обсудить с другими пользователями службу Azure ATP и связанные с ней вопросы безопасности? Присоединяйтесь к [сообществу Azure ATP](https://techcommunity.microsoft.com/t5/Azure-Advanced-Threat-Protection/bd-p/AzureAdvancedThreatProtection)!

